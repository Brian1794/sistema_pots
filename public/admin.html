<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Ferreter√≠a</title>
    <link rel="stylesheet" href="./css/admin.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        /* ====================================================================
           MODALES PROFESIONALES PARA REPARACIONES
           ==================================================================== */

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }

        

        .modal-overlay.activo {
            display: flex;
        }

        .modal-pro {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        .modal-pro.modal-grande {
            max-width: 700px;
        }

        .modal-pro.modal-confirmacion {
            max-width: 450px;
        }

        .modal-header-pro {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            border-bottom: 2px solid #f0f0f0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
        }

        .modal-header-pro h2 {
            margin: 0;
            font-size: 1.4em;
            color: #333;
        }

        .modal-close-pro {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #666;
            transition: color 0.2s;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close-pro:hover {
            background: rgba(230, 57, 70, 0.1);
            color: #e63946;
        }

        .modal-body-pro {
            padding: 24px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-body-pro p {
            margin: 12px 0;
            line-height: 1.6;
            color: #555;
        }

        .modal-body-pro .detalles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin: 12px 0;
        }

        .modal-body-pro .detalle-item {
            background: #f9f9f9;
            padding: 12px;
            border-left: 4px solid #e63946;
            border-radius: 4px;
        }

        .modal-body-pro .detalle-label {
            font-weight: 600;
            color: #e63946;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .modal-body-pro .detalle-valor {
            color: #333;
            font-size: 1em;
        }

        .modal-footer-pro {
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #fafafa;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Input readonly styling */
        input[readonly] {
            background-color: #f5f5f5 !important;
            cursor: not-allowed;
        }

        /* Estado badge mejorado */
        .estado-badge-pro {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .estado-badge-pro.recibido {
            background: #e3f2fd;
            color: #1976d2;
        }

        .estado-badge-pro.diagnostico {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .estado-badge-pro.reparacion {
            background: #fff3e0;
            color: #e65100;
        }

        .estado-badge-pro.listo {
            background: #f1f8e9;
            color: #558b2f;
        }

        .estado-badge-pro.entregado {
            background: #e8f5e9;
            color: #2e7d32;
        }

        /* Acciones con tooltips */
        .acciones-reparacion {
            display: flex;
            gap: 8px;
        }

        .btn-accion {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .btn-accion:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            z-index: 999;
        }

        .btn-ver {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-ver:hover {
            background: #bbdefb;
            transform: scale(1.1);
        }

        .btn-editar {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .btn-editar:hover {
            background: #e1bee7;
            transform: scale(1.1);
        }

        .btn-eliminar {
            background: #ffebee;
            color: #c62828;
        }

        .btn-eliminar:hover {
            background: #ef5350;
            color: white;
            transform: scale(1.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-pro {
                width: 95%;
                max-width: none;
            }

            .modal-body-pro .detalles-grid {
                grid-template-columns: 1fr;
            }

            .modal-footer-pro {
                flex-direction: column-reverse;
            }

            .modal-footer-pro .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- MODAL DE LOGIN -->
    <div id="modalLogin" class="modal-login">
        <div class="contenedor-login">
            <div class="login-caja">
                <div class="login-header">
                    <div class="login-icon">üîê</div>
                    <h1 class="login-titulo">Panel de Administraci√≥n</h1>
                    <p class="login-subtitulo">Ferreter√≠a Local</p>
                </div>
                
                <form id="formularioLogin" onsubmit="iniciarSesion(event)" class="login-form">
                    <div class="grupo-login">
                        <label for="usuarioLogin">Usuario</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üë§</span>
                            <input type="text" id="usuarioLogin" placeholder="admin" required autofocus>
                        </div>
                    </div>

                    <div class="grupo-login">
                        <label for="passwordLogin">Contrase√±a</label>
                        <div class="input-wrapper">
                            <span class="input-icon">üîë</span>
                            <input type="password" id="passwordLogin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            <button type="button" class="btn-show-password" onclick="togglePasswordVisibility()">üëÅÔ∏è</button>
                        </div>
                    </div>

                    <div id="mensajeLoginError" class="mensaje-login-error"></div>

                    <button type="submit" class="btn-login" id="btnLogin">
                        <span class="btn-login-text">Iniciar Sesi√≥n</span>
                        <span class="btn-login-loader"></span>
                    </button>
                </form>

                
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: PEDIDO DE COMPRA -->
    <div class="modal-overlay" id="modalPedidoCompra">
        <div class="modal-pro modal-grande">
            <div class="modal-header-pro">
                <h2>üßæ Pedido de Compra - Preview</h2>
                <button class="modal-close-pro" onclick="cerrarModalPedido()">‚úï</button>
            </div>
            <div class="modal-body-pro" id="modalPedidoContent">
                <!-- Contenido generado din√°micamente -->
            </div>
            <div class="modal-footer-pro">
                <button class="btn btn-secundario" onclick="cerrarModalPedido()">Cerrar</button>
                <button class="btn btn-primario" onclick="guardarPedidoServidor()">üíæ Guardar pedido en servidor</button>
                <button class="btn btn-primario" onclick="descargarPedido()">üì• Descargar CSV</button>
            </div>
        </div>
    </div>

    <!-- ENCABEZADO -->
    <header id="encabezado">
        <div class="header-contenido">
            <button class="btn-toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>
            <div class="logo">üìä Panel Administrativo</div>
            <div class="usuario-info">
                <span id="usuarioActual">admin</span>
                <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi√≥n</button>
            </div>
        </div>
    </header>

    <!-- SIDEBAR NAVEGACI√ìN -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h2 class="sidebar-titulo">üöÄ Control Hub</h2>
            <button class="btn-close-sidebar" onclick="closeSidebar()">‚úï</button>
        </div>

        <nav class="sidebar-nav">
            <!-- DASHBOARD -->
            <a href="#" class="nav-item activo" onclick="cambiarTab('analytics'); closeSidebar()">
                <span class="nav-icon">üìä</span>
                <span class="nav-texto">Dashboard</span>
                <span class="nav-badge"></span>
            </a>

            <!-- INVENTARIO CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üì¶</span>
                    <span class="nav-texto">Inventario</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('productos'); cambiarSubTab('lista-productos'); closeSidebar()">
                        <span class="nav-subicon">üìã</span>
                        <span class="nav-subtexto">Lista Productos</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('productos'); cambiarSubTab('agregar-producto'); closeSidebar()">
                        <span class="nav-subicon">‚ûï</span>
                        <span class="nav-subtexto">Agregar Producto</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('productos'); cambiarSubTab('gestionar-categorias'); closeSidebar()">
                        <span class="nav-subicon">üè∑Ô∏è</span>
                        <span class="nav-subtexto">Categor√≠as</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('productos'); cambiarSubTab('stock-bajo'); closeSidebar()">
                        <span class="nav-subicon">üìä</span>
                        <span class="nav-subtexto">Stock Bajo</span>
                        <span class="nav-badge" id="badgeStockBajo">0</span>
                    </a>
                </div>
            </div>

            <!-- VENTAS CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üí∞</span>
                    <span class="nav-texto">Ventas</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('ventas'); closeSidebar()">
                        <span class="nav-subicon">üìà</span>
                        <span class="nav-subtexto">Historial</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üìÖ</span>
                        <span class="nav-subtexto">Por Per√≠odo</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üéØ</span>
                        <span class="nav-subtexto">Metas</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üìä</span>
                        <span class="nav-subtexto">Reportes</span>
                    </a>
                </div>
            </div>

            <!-- PUNTO DE VENTA CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üõí</span>
                    <span class="nav-texto">Punto de Venta</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('puntoventa'); closeSidebar()">
                        <span class="nav-subicon">üí≥</span>
                        <span class="nav-subtexto">Caja</span>
                    </a>
                   
                    </a>
                    <a href="" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üßæ</span>
                        <span class="nav-subtexto">Recibos</span>
                    </a>
                </div>
            </div>

            <!-- REPARACIONES CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üîß</span>
                    <span class="nav-texto">Reparaciones</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('reparaciones'); cambiarSubTab('agregar-reparacion'); closeSidebar()">
                        <span class="nav-subicon">‚ûï</span>
                        <span class="nav-subtexto">Nueva Orden</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('reparaciones'); cambiarSubTab('lista-reparaciones'); closeSidebar()">
                        <span class="nav-subicon">üìã</span>
                        <span class="nav-subtexto">√ìrdenes</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('reparaciones'); cambiarSubTab('tecnicos'); closeSidebar()">
                        <span class="nav-subicon">üë®‚Äçüîß</span>
                        <span class="nav-subtexto">T√©cnicos</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üìä</span>
                        <span class="nav-subtexto">Seguimiento</span>
                    </a>
                </div>
            </div>

            <div class="nav-divider"></div>

            <!-- RECURSOS CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üóÇÔ∏è</span>
                    <span class="nav-texto">Recursos</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üñºÔ∏è</span>
                        <span class="nav-subtexto">Media</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üë•</span>
                        <span class="nav-subtexto">Clientes</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üìû</span>
                        <span class="nav-subtexto">Contactos</span>
                    </a>
                </div>
            </div>
            
            <!-- PROVEEDORES CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üè≠</span>
                    <span class="nav-texto">Proveedores</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('proveedores'); cambiarSubTab('prov-lista'); mostrarProveedores(''); closeSidebar()">
                        <span class="nav-subicon">üìã</span>
                        <span class="nav-subtexto">Lista de Proveedores</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('proveedores'); cambiarSubTab('prov-ordenes'); cargarOrdenesCompra(); closeSidebar()">
                        <span class="nav-subicon">üì¶</span>
                        <span class="nav-subtexto">√ìrdenes de Compra</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('proveedores'); cambiarSubTab('prov-analisis'); cargarAnalisisProveedores(); closeSidebar()">
                        <span class="nav-subicon">üìä</span>
                        <span class="nav-subtexto">An√°lisis</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="cambiarTab('proveedores'); cambiarSubTab('prov-agregar'); abrirFormularioNuevoProveedor(); closeSidebar()">
                        <span class="nav-subicon">‚ûï</span>
                        <span class="nav-subtexto">Nuevo Proveedor</span>
                    </a>
                </div>
            </div>

            <!-- SISTEMA CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-texto">Sistema</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="cambiarTab('configuracion'); closeSidebar()">
                        <span class="nav-subicon">üîß</span>
                        <span class="nav-subtexto">Configuraci√≥n</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üé®</span>
                        <span class="nav-subtexto">Tema</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üîå</span>
                        <span class="nav-subtexto">Plugins</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üìù</span>
                        <span class="nav-subtexto">Logs</span>
                    </a>
                </div>
            </div>

            <div class="nav-divider"></div>

            <!-- CUENTA CON SUBMENU -->
            <div class="nav-category">
                <button class="nav-category-btn" onclick="toggleNavCategory(event)">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-texto">Cuenta</span>
                    <span class="nav-chevron">‚Ä∫</span>
                </button>
                <div class="nav-submenu">
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üë§</span>
                        <span class="nav-subtexto">Mi Perfil</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üîê</span>
                        <span class="nav-subtexto">Seguridad</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üîî</span>
                        <span class="nav-subtexto">Notificaciones</span>
                    </a>
                    <a href="#" class="nav-subitem" onclick="closeSidebar()">
                        <span class="nav-subicon">üíæ</span>
                        <span class="nav-subtexto">Almacenamiento</span>
                    </a>
                </div>
            </div>

            <!-- AYUDA -->
            <a href="#" class="nav-item nav-help" onclick="closeSidebar()">
                <span class="nav-icon">‚ùì</span>
                <span class="nav-texto">Ayuda & Soporte</span>
                <span class="nav-badge"></span>
            </a>
        </nav>
    </aside>

    <!-- OVERLAY PARA CERRAR SIDEBAR EN MOBILE -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="contenido-principal">
        <div id="tab-productos" class="tab-contenido">
            <h2 class="seccion-titulo">üì¶ Gesti√≥n de Productos</h2>

            <div id="mensajeContenedorRep"></div>

            <!-- TABS DE PRODUCTOS Y CATEGOR√çAS -->
            <div class="sub-tabs-productos">
                <button class="sub-tab-btn activo" onclick="cambiarSubTab('agregar-producto')">‚ûï Agregar Producto</button>
                <button class="sub-tab-btn" onclick="cambiarSubTab('gestionar-categorias')">üè∑Ô∏è Gestionar Categor√≠as</button>
                <button class="sub-tab-btn" onclick="cambiarSubTab('lista-productos')">üìã Lista de Productos</button>
                <button class="sub-tab-btn" onclick="cambiarSubTab('stock-bajo')">üìâ Stock Bajo</button>
            </div>

            <!-- SUB-TAB: AGREGAR PRODUCTO -->
            <div id="subtab-agregar-producto" class="sub-tab-contenido activo">
                <div class="formulario">
                    <h3 class="titulo-formulario">
                        <span id="tituloFormulario">‚úèÔ∏è Agregar Nuevo Producto</span>
                    </h3>

                    <form id="formularioProducto" onsubmit="guardarProducto(event)">
                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label for="nombre">Nombre del Producto *</label>
                                <input type="text" id="nombre" placeholder="Ej: Martillo de Garra" required>
                            </div>
                            <div class="grupo-formulario">
                                <label for="categoria">Categor√≠a *</label>
                                <select id="categoria" required onchange="actualizarCategoriasProducto()">
                                    <option value="">-- Selecciona categor√≠a --</option>
                                </select>
                            </div>
                        </div>

                        <div class="grupo-formulario">
                            <label for="descripcion">Descripci√≥n</label>
                            <textarea id="descripcion" placeholder="Descripci√≥n del producto" rows="3"></textarea>
                        </div>

                        <div class="fila-tres">
                            <div class="grupo-formulario">
                                <label for="stock">Stock (unidades) *</label>
                                <input type="number" id="stock" min="0" placeholder="0" required>
                            </div>
                            <div class="grupo-formulario">
                                <label for="precio">Precio Unitario ($) *</label>
                                <input type="number" id="precio" min="0" step="0.01" placeholder="0.00" required>
                            </div>
                            <div class="grupo-formulario">
                                <label for="imagen">URL de Imagen</label>
                                <input type="url" id="imagen" placeholder="https://ejemplo.com/imagen.jpg">
                            </div>
                        </div>

                        <div class="botones-formulario">
                            <button type="submit" class="btn btn-primario btn-grande">üíæ Guardar Producto</button>
                            <button type="button" class="btn btn-secundario" onclick="limpiarFormulario()">üîÑ Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SUB-TAB: GESTIONAR CATEGOR√çAS -->
            <div id="subtab-gestionar-categorias" class="sub-tab-contenido">
                <div class="formulario">
                    <h3 class="titulo-formulario">üè∑Ô∏è Gesti√≥n de Categor√≠as</h3>

                    <div class="grupo-formulario">
                        <label for="nombreCategoria">Nueva Categor√≠a *</label>
                        <input type="text" id="nombreCategoria" placeholder="Ej: Equipos de Seguridad" required>
                    </div>

                    <button class="btn btn-primario" onclick="agregarCategoria()">‚ûï Agregar Categor√≠a</button>

                    <h4 class="titulo-categorias">Categor√≠as Actuales</h4>
                    <div id="listaCategorias" class="lista-categorias">
                        <p class="sin-datos">Cargando categor√≠as...</p>
                    </div>
                </div>
            </div>

            <!-- SUB-TAB: LISTA DE PRODUCTOS -->
            <div id="subtab-lista-productos" class="sub-tab-contenido">
                <div class="filtro-busqueda">
                    <input 
                        type="text" 
                        id="buscadorProductos" 
                        placeholder="üîç Buscar productos por nombre..."
                        onkeyup="filtrarTablaProductos()"
                    >
                    <select id="filtroCategoria" onchange="filtrarTablaProductos()" title="Filtrar por categor√≠a">
                        <option value="">üìÅ Todas las categor√≠as</option>
                    </select>
                </div>

                <table class="tabla tabla-productos">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Descripci√≥n</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th class="acciones-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="productosTabla">
                        <tr>
                            <td colspan="6" class="sin-datos">Cargando productos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- SUB-TAB: STOCK BAJO -->
            <div id="subtab-stock-bajo" class="sub-tab-contenido">
                <h3 class="titulo-formulario">üìâ Productos con Stock Bajo</h3>
                <div class="filtro-busqueda">
                    <label class="label-umbral" for="umbralStockBajo">Umbral:</label>
                    <input type="number" id="umbralStockBajo" class="input-umbral" value="5" min="1" onchange="cargarStockBajo()">
                    <select id="selectProveedorPedido" class="input-umbral select-proveedor" aria-label="Seleccionar proveedor">
                        <option value="">Seleccionar proveedor (opcional)</option>
                    </select>
                    <button class="btn btn-secundario btn-margin-left" onclick="cargarStockBajo()">üîÑ Actualizar</button>
                    <button class="btn btn-primario btn-margin-left" onclick="crearPedidoCompra()">üßæ Crear pedido de compra</button>
                </div>

                <table class="tabla tabla-productos">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th class="acciones-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="stockBajoTabla">
                        <tr><td colspan="5" class="sin-datos">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PESTA√ëA: VENTAS -->
        <div id="tab-ventas" class="tab-contenido">
            <h2 class="seccion-titulo">üìä Historial de Ventas</h2>

            <div class="estadistica" id="estadisticasVentas">
                <!-- Las estad√≠sticas se cargar√°n aqu√≠ -->
            </div>

            <div class="filtro-busqueda">
                <input 
                    type="text" 
                    id="buscadorVentas" 
                    placeholder="Buscar por ID de venta o cliente..."
                    onkeyup="filtrarTablaVentas()"
                >
                <button class="btn btn-secundario btn-margin-left" onclick="abrirModalDias()">üìÖ Historial de D√≠as</button>
            </div>

            <div id="ventasContenedor" class="ventas-contenedor">
                <table class="tabla tabla-ventas">
                    <thead>
                        <tr>
                            <th>ID Compra</th>
                            <th>Cliente</th>
                            <th>Fecha/Hora</th>
                            <th>Productos</th>
                            <th>Monto Total</th>
                            <th class="acciones-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ventasTabla">
                        <tr>
                            <td colspan="6" class="sin-datos">Cargando ventas...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PESTA√ëA: PROVEEDORES -->
        <div id="tab-proveedores" class="tab-contenido">
            <h2 class="seccion-titulo">üè≠ Gesti√≥n de Proveedores</h2>

            <!-- (Opciones de Proveedores removidas aqu√≠ porque ahora est√°n en el men√∫ lateral para evitar duplicaci√≥n) -->
            <!-- Las acciones se manejan desde el sidebar; el contenido de cada sub-tab permanece abajo. -->

            <!-- SUBTAB: LISTA -->
            <div id="subtab-prov-lista" class="sub-tab-contenido activo">
                <div class="list-toolbar">
                    <div class="search-group">
                        <input type="text" id="buscadorProveedores" placeholder="üîç Buscar por nombre, NIT, tel√©fono..." onkeyup="filtrarProveedores()" class="search-input">
                    </div>
                    <div class="toolbar-buttons">
                        <button class="btn btn-secundario btn-sm" onclick="exportarProveedores()">
                            <span>üì•</span> Exportar
                        </button>
                        <button class="btn btn-secundario btn-sm" onclick="mostrarFiltrosAvanzados()">
                            <span>‚öôÔ∏è</span> Filtros
                        </button>
                    </div>
                </div>

                <!-- FILTROS AVANZADOS (Ocultos por defecto) -->
                <div id="filtrosAvanzados" class="filtros-avanzados oculto">
                    <div class="filtro-grid">
                        <div class="filtro-item">
                            <label>Ciudad</label>
                            <input type="text" id="filtCiudad" placeholder="Filtrar por ciudad..." onkeyup="filtrarProveedores()">
                        </div>
                        <div class="filtro-item">
                            <label>Categor√≠a</label>
                            <input type="text" id="filtCategoria" placeholder="Filtrar por categor√≠a..." onkeyup="filtrarProveedores()">
                        </div>
                        <div class="filtro-item">
                            <label>Estado</label>
                            <select id="filtEstado" onchange="filtrarProveedores()">
                                <option value="">Todos</option>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <table class="tabla tabla-productos tabla-proveedores">
                    <thead>
                        <tr>
                            <th class="col-nombre">Empresa</th>
                            <th class="col-nit">NIT</th>
                            <th class="col-contacto">Contacto</th>
                            <th class="col-telefono">Tel√©fono</th>
                            <th class="col-email">Email</th>
                            <th class="col-ciudad">Ciudad</th>
                            <th class="col-ordenes">√ìrdenes</th>
                            <th class="acciones-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="proveedoresTabla">
                        <tr><td colspan="8" class="sin-datos">Cargando proveedores...</td></tr>
                    </tbody>
                </table>

                <div class="tabla-resumen">
                    <span class="resumen-item"><strong id="totalProveedores">0</strong> Proveedores</span>
                    <span class="resumen-item"><strong id="totalOrdenes">0</strong> √ìrdenes Activas</span>
                    <span class="resumen-item"><strong id="proveedoresActivos">0</strong> Activos</span>
                </div>
            </div>

            <!-- SUBTAB: AGREGAR/EDITAR (Oculto en interfaz principal, accesible por bot√≥n) -->
            <div id="subtab-prov-agregar" class="sub-tab-contenido">
                <div class="form-header">
                    <h3 id="formTitulo" class="titulo-formulario">‚ûï Nuevo Proveedor</h3>
                    <button class="btn-close" onclick="cambiarSubTab('prov-lista')">‚úï</button>
                </div>
                <div class="formulario form-proveedores">
                    <form id="formularioProveedor" onsubmit="guardarProveedor(event)">
                        <input type="hidden" id="provId">

                        <div class="form-card">
                            <div class="form-card-header form-card-header--row">
                                <div class="flex-row-center">
                                    <div class="provider-icon">üè≠</div>
                                    <div>
                                        <div class="provider-title">‚ûï Nuevo Proveedor</div>
                                        <div class="provider-subtitle">Registro r√°pido y detalles comerciales</div>
                                    </div>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secundario" onclick="limpiarFormularioProveedor(); cambiarSubTab('prov-lista');">‚úï Cerrar</button>
                                </div>
                            </div>

                            <div class="form-card-body form-card-body-grid">
                                <div>
                                    <!-- Informaci√≥n b√°sica y contacto -->
                                    <div class="form-seccion">
                                        <h4 class="form-seccion-titulo">Informaci√≥n B√°sica</h4>
                                        <div class="fila-dos">
                                            <div class="grupo-formulario">
                                                <label for="provNombre">Nombre Empresa <span class="requerido">*</span></label>
                                                <input type="text" id="provNombre" placeholder="Nombre completo de la empresa" required>
                                            </div>
                                            <div class="grupo-formulario">
                                                <label for="provNIT">NIT / C√©dula</label>
                                                <input type="text" id="provNIT" placeholder="Opcional">
                                            </div>
                                        </div>

                                        <div class="fila-dos">
                                            <div class="grupo-formulario">
                                                <label for="provCiudad">Ciudad</label>
                                                <input type="text" id="provCiudad" placeholder="Ciudad">
                                            </div>
                                            <div class="grupo-formulario">
                                                <label for="provDireccion">Direcci√≥n</label>
                                                <input type="text" id="provDireccion" placeholder="Direcci√≥n f√≠sica">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-seccion">
                                        <h4 class="form-seccion-titulo">Contacto</h4>
                                        <div class="fila-dos">
                                            <div class="grupo-formulario">
                                                <label for="provContacto">Persona de Contacto</label>
                                                <input type="text" id="provContacto" placeholder="Nombre y cargo">
                                            </div>
                                            <div class="grupo-formulario">
                                                <label for="provEmail">Correo</label>
                                                <input type="email" id="provEmail" placeholder="contacto@empresa.com">
                                            </div>
                                        </div>
                                        <div class="fila-dos">
                                            <div class="grupo-formulario">
                                                <label for="provTelefono">Tel√©fono Principal</label>
                                                <input type="text" id="provTelefono" placeholder="+57 300 000 0000">
                                            </div>
                                            <div class="grupo-formulario">
                                                <label for="provTelefono2">Tel√©fono Secundario</label>
                                                <input type="text" id="provTelefono2" placeholder="Opcional">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-seccion">
                                        <h4 class="form-seccion-titulo">Detalles Comerciales</h4>
                                        <div class="fila-dos">
                                            <div class="grupo-formulario">
                                                <label for="provCategorias">Categor√≠as</label>
                                                <input type="text" id="provCategorias" placeholder="Ej: Herramientas, Ferreter√≠a">
                                            </div>
                                            <div class="grupo-formulario">
                                                <label for="provPagos">M√©todos de Pago</label>
                                                <input type="text" id="provPagos" placeholder="Transferencia, Efectivo, Cr√©dito">
                                            </div>
                                        </div>

                                        <div class="grupo-formulario">
                                            <label for="provNotas">Notas / T√©rminos</label>
                                            <textarea id="provNotas" class="textarea-large" placeholder="Condiciones, descuentos, plazos"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <aside class="aside-column">
                                    <div class="panel-header panel-summary">
                                        <h4 style="margin:0;color:#333;font-size:0.95rem;">Estado & Resumen</h4>
                                    </div>
                                    <div class="panel-summary">
                                        <label for="provEstado">Estado</label>
                                        <select id="provEstado" class="select-full">
                                            <option value="Activo">Activo</option>
                                            <option value="Inactivo">Inactivo</option>
                                        </select>
                                        <div class="text-muted" style="margin-top:12px;">Fecha creaci√≥n: <span id="provFechaCreacion">(se genera al guardar)</span></div>
                                    </div>
                                    <div style="margin-top:auto;display:flex;gap:10px;">
                                        <button type="submit" class="btn btn-primario btn-grande flex-1">üíæ Guardar</button>
                                        <button type="button" class="btn btn-secundario" onclick="limpiarFormularioProveedor(); cambiarSubTab('prov-lista');">‚úï Cancelar</button>
                                    </div>
                                </aside>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SUBTAB: √ìRDENES DE COMPRA -->
            <div id="subtab-prov-ordenes" class="sub-tab-contenido">
                <div class="ordenes-container">
                    <!-- PANEL CREAR ORDEN -->
                    <div class="orden-form-panel">
                        <div class="panel-header">
                            <h3>üì¶ Crear Nueva Orden de Compra</h3>
                        </div>
                        <form id="formularioOrden" onsubmit="guardarOrdenCompra(event)" class="form-orden-compra">
                            <div class="fila-dos">
                                <div class="grupo-formulario">
                                    <label for="ordenProveedor">Proveedor <span class="requerido">*</span></label>
                                    <select id="ordenProveedor" required class="select-grande">
                                        <option value="">Seleccionar proveedor...</option>
                                    </select>
                                </div>
                                <div class="grupo-formulario">
                                    <label for="ordenFechaEstimada">Fecha Estimada Entrega</label>
                                    <input type="date" id="ordenFechaEstimada" class="input-grande">
                                </div>
                            </div>

                            <div class="grupo-formulario">
                                <label>Productos <span class="requerido">*</span></label>
                                <div id="ordenProductos" class="orden-productos">
                                    <div class="fila-orden">
                                        <select class="select-producto" onchange="calcularTotalOrden()">
                                            <option value="">Agregar producto...</option>
                                        </select>
                                        <input type="number" placeholder="Cant." min="1" class="input-cantidad" onchange="calcularTotalOrden()">
                                        <input type="number" placeholder="Costo" min="0" step="0.01" class="input-costo" onchange="calcularTotalOrden()">
                                        <button type="button" class="btn-eliminar-fila" onclick="eliminarProductoOrden(this)" title="Eliminar">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secundario btn-sm btn-agregar-fila" onclick="agregarFilaProductoOrden()">
                                    <span>‚ûï</span> Agregar Producto
                                </button>
                            </div>

                            <div class="grupo-formulario total-orden">
                                <label>Total Estimado</label>
                                <div class="total-display">
                                    <input type="text" id="ordenTotal" readonly placeholder="$0.00" class="total-input">
                                </div>
                            </div>

                            <div class="botones-formulario">
                                <button type="submit" class="btn btn-primario btn-grande">
                                    <span>üì•</span> Crear Orden
                                </button>
                                <button type="button" class="btn btn-secundario" onclick="limpiarFormularioOrden()">
                                    <span>üîÑ</span> Limpiar
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- PANEL √ìRDENES REGISTRADAS -->
                    <div class="orden-lista-panel">
                        <div class="panel-header">
                            <h3>üìã √ìrdenes Registradas</h3>
                            <div class="header-stats">
                                <span class="stat-badge"><strong id="totalOrdenesAct">0</strong> Pendientes</span>
                                <span class="stat-badge pendientes"><strong id="totalOrdenesProc">0</strong> En Proceso</span>
                            </div>
                        </div>

                        <div class="lista-filtros">
                            <div class="filtros-grupo">
                                <select id="filtroEstadoOrden" onchange="filtrarOrdenes()" class="filtro-select">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="en_proceso">En Proceso</option>
                                    <option value="recibido">Recibido</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                                <input type="text" id="buscadorOrdenes" placeholder="üîç Buscar orden, proveedor..." onkeyup="filtrarOrdenes()" class="filtro-input">
                            </div>
                        </div>

                        <div class="tabla-wrapper">
                            <table class="tabla tabla-ordenes">
                                <thead>
                                    <tr>
                                        <th class="col-id">ID</th>
                                        <th class="col-proveedor">Proveedor</th>
                                        <th class="col-fecha">Fecha</th>
                                        <th class="col-entrega">Entrega Est.</th>
                                        <th class="col-monto">Monto</th>
                                        <th class="col-estado">Estado</th>
                                        <th class="acciones-header">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="ordenesTabla">
                                    <tr><td colspan="7" class="sin-datos">Cargando √≥rdenes...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUBTAB: AN√ÅLISIS (Nuevo) -->
            <div id="subtab-prov-analisis" class="sub-tab-contenido">
                <div class="analisis-container">
                    <h3 class="titulo-formulario">üìä An√°lisis de Proveedores</h3>
                    
                    <div class="analisis-grid">
                        <div class="analisis-card">
                            <div class="card-header">
                                <h4>Total Proveedores</h4>
                            </div>
                            <div class="card-valor">
                                <span id="anaOrdenes" class="valor-grande">0</span>
                                <span class="card-label">Registrados</span>
                            </div>
                        </div>

                        <div class="analisis-card">
                            <div class="card-header">
                                <h4>√ìrdenes Totales</h4>
                            </div>
                            <div class="card-valor">
                                <span id="anaTotalOrdenes" class="valor-grande">0</span>
                                <span class="card-label">Creadas</span>
                            </div>
                        </div>

                        <div class="analisis-card">
                            <div class="card-header">
                                <h4>Monto Total</h4>
                            </div>
                            <div class="card-valor">
                                <span id="anaMonto" class="valor-grande">$0</span>
                                <span class="card-label">Invertido</span>
                            </div>
                        </div>

                        <div class="analisis-card">
                            <div class="card-header">
                                <h4>Pendientes</h4>
                            </div>
                            <div class="card-valor" style="color: #f39c12;">
                                <span id="anaPendientes" class="valor-grande">0</span>
                                <span class="card-label">En proceso</span>
                            </div>
                        </div>
                    </div>

                    <div class="top-proveedores">
                        <h4>üèÜ Top Proveedores (por √≥rdenes)</h4>
                        <div id="topProveedores" class="top-lista">
                            <p class="sin-datos">Cargando datos...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL HISTORIAL D√çAS -->
        <div class="modal" id="modalDias">
            <div class="modal-contenido modal-max-width">
                <button class="btn-cerrar-modal" onclick="cerrarModalDias()">‚úï</button>
                <h2 class="modal-titulo">Historial de D√≠as</h2>
                <div id="contenidoDias">
                    <p>Cargando d√≠as...</p>
                </div>
                <div class="modal-footer-margin">
                    <button class="btn btn-secundario" onclick="cerrarModalDias()">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: VER REPARACI√ìN -->
        <div class="modal-overlay" id="modalVerReparacion">
            <div class="modal-pro">
                <div class="modal-header-pro">
                    <h2 id="verRepTitulo">üìã Detalles de Reparaci√≥n</h2>
                    <button class="modal-close-pro" onclick="cerrarModal('modalVerReparacion')">‚úï</button>
                </div>
                <div class="modal-body-pro" id="modalVerRepContent">
                    <!-- Contenido din√°mico -->
                </div>
                <div class="modal-footer-pro">
                    <button class="btn btn-secundario" onclick="cerrarModal('modalVerReparacion')">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: EDITAR REPARACI√ìN -->
        <div class="modal-overlay" id="modalEditarReparacion">
            <div class="modal-pro modal-grande">
                <div class="modal-header-pro">
                    <h2>‚úèÔ∏è Editar Reparaci√≥n</h2>
                    <button class="modal-close-pro" onclick="cerrarModal('modalEditarReparacion')">‚úï</button>
                </div>
                <div class="modal-body-pro">
                    <form id="formularioEditarReparacion" onsubmit="guardarReparacionEditada(event)">
                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label>Cliente</label>
                                <input type="text" id="editRepClienteNombre" readonly class="input-readonly-bg">
                            </div>
                            <div class="grupo-formulario">
                                <label>Tel√©fono</label>
                                <input type="text" id="editRepClienteTelefono" readonly class="input-readonly-bg">
                            </div>
                        </div>

                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label>Equipo</label>
                                <input type="text" id="editRepEquipo" readonly class="input-readonly-bg">
                            </div>
                            <div class="grupo-formulario">
                                <label>Estado *</label>
                                <select id="editRepEstado" required>
                                    <option value="">-- Selecciona --</option>
                                    <option value="Recibido">Recibido</option>
                                    <option value="Diagn√≥stico">Diagn√≥stico</option>
                                    <option value="En Reparaci√≥n">En Reparaci√≥n</option>
                                    <option value="Listo">Listo</option>
                                    <option value="Entregado">Entregado</option>
                                </select>
                            </div>
                        </div>

                        <div class="grupo-formulario">
                            <label>Diagn√≥stico</label>
                            <textarea id="editRepDiagnostico" placeholder="Detalles del diagn√≥stico" rows="3"></textarea>
                        </div>

                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label>Costo Estimado ($)</label>
                                <input type="number" id="editRepCosto" min="0" step="0.01">
                            </div>
                            <div class="grupo-formulario">
                                <label>T√©cnico Asignado</label>
                                <select id="editRepTecnico">
                                    <option value="">-- Sin asignar --</option>
                                </select>
                            </div>
                        </div>

                        <div class="modal-footer-pro">
                            <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalEditarReparacion')">Cancelar</button>
                            <button type="submit" class="btn btn-primario">üíæ Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- MODAL: ELIMINAR REPARACI√ìN -->
        <div class="modal-overlay" id="modalEliminarReparacion">
            <div class="modal-pro modal-confirmacion">
                <div class="modal-header-pro">
                    <h2>‚ö†Ô∏è Confirmar Eliminaci√≥n</h2>
                </div>
                <div class="modal-body-pro">
                    <p>¬øEst√°s seguro de que deseas eliminar esta reparaci√≥n?</p>
                    <p id="elimRepInfo" class="info-text-error"></p>
                </div>
                <div class="modal-footer-pro">
                    <button class="btn btn-secundario" onclick="cerrarModal('modalEliminarReparacion')">Cancelar</button>
                    <button class="btn btn-peligro btn-danger-custom" onclick="confirmarEliminarReparacion()">üóëÔ∏è Eliminar</button>
                </div>
            </div>
        </div>

        <!-- MODAL: EDITAR T√âCNICO -->
        <div class="modal-overlay" id="modalEditarTecnico">
            <div class="modal-pro">
                <div class="modal-header-pro">
                    <h2>‚úèÔ∏è Editar T√©cnico</h2>
                    <button class="modal-close-pro" onclick="cerrarModal('modalEditarTecnico')">‚úï</button>
                </div>
                <div class="modal-body-pro">
                    <form id="formularioEditarTecnico" onsubmit="guardarTecnicoEditado(event)">
                        <div class="grupo-formulario">
                            <label>Nombre *</label>
                            <input type="text" id="editTecNombre" required>
                        </div>
                        <div class="grupo-formulario">
                            <label>Tel√©fono</label>
                            <input type="tel" id="editTecTelefono">
                        </div>
                        <div class="grupo-formulario">
                            <label>Email</label>
                            <input type="email" id="editTecEmail">
                        </div>
                        <div class="modal-footer-pro">
                            <button type="button" class="btn btn-secundario" onclick="cerrarModal('modalEditarTecnico')">Cancelar</button>
                            <button type="submit" class="btn btn-primario">üíæ Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA: ANALYTICS -->
        <div id="tab-analytics" class="tab-contenido activo">
            <h2 class="seccion-titulo">üìä Analytics y Reportes</h2>

            <!-- Selector de per√≠odo -->
            <div class="analytics-controles">
                <div class="selector-periodo">
                    <label for="selectorFecha">Per√≠odo:</label>
                    <select id="selectorFecha" onchange="actualizarAnalytics()">
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este Mes</option>
                        <option value="todo">Todo el Per√≠odo</option>
                    </select>
                </div>
                <div class="botones-analytics">
                    <button class="btn btn-primario" onclick="descargarReporte()">üì• Descargar Reporte</button>
                    <button class="btn btn-secundario" onclick="imprimirAnalytics()">üñ®Ô∏è Imprimir</button>
                </div>
            </div>

            <!-- Cards de estad√≠sticas principales -->
            <div class="stats-principales" id="statsPrincipales">
                <!-- Se cargar√°n din√°micamente -->
            </div>

            <!-- Gr√°ficos -->
            <div class="graficos-contenedor">
                <div class="grafico-card">
                    <h3>üìà Ventas por Hora</h3>
                    <canvas id="chartVentasPorHora"></canvas>
                </div>
                <div class="grafico-card">
                    <h3>üèÜ Top 5 Productos</h3>
                    <canvas id="chartTopProductos"></canvas>
                </div>
            </div>

            <div class="graficos-contenedor">
                <div class="grafico-card ancho-completo">
                    <h3>üíπ Tendencia de Ventas</h3>
                    <canvas id="chartTendencia"></canvas>
                </div>
            </div>

            <!-- Tabla de resumen -->
            <div class="resumen-tabla-contenedor">
                <h3>üìã Resumen de Productos Vendidos</h3>
                <table class="tabla-resumen" id="tablaResumen">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Ingresos</th>
                            <th>% de Ventas</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaResumen">
                        <tr><td colspan="4" class="sin-datos">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="tab-puntoventa" class="tab-contenido">
            <div class="contenedor-punto-venta">
                <h2 class="seccion-titulo">üõí Sistema de Punto de Venta</h2>
                <p class="texto-punto-venta">Accede al sistema de ventas optimizado</p>
                <button class="btn btn-primario btn-grande-pv" onclick="abrirPuntoVenta()">
                    Abrir Punto de Venta
                </button>
            </div>
        </div>

        <!-- PESTA√ëA: REPARACIONES -->
        <div id="tab-reparaciones" class="tab-contenido">
            <h2 class="seccion-titulo">üîß Gesti√≥n de Reparaciones</h2>

            <div id="mensajeContenedor"></div>

            <!-- TABS DE REPARACIONES -->
            <div class="sub-tabs-productos">
                <button class="sub-tab-btn activo" onclick="cambiarSubTab('agregar-reparacion')">‚ûï Agregar Reparaci√≥n</button>
                <button class="sub-tab-btn" onclick="cambiarSubTab('lista-reparaciones')">üìã Lista de Reparaciones</button>
                <button class="sub-tab-btn" onclick="cambiarSubTab('tecnicos')">üë®‚Äçüîß Gesti√≥n de T√©cnicos</button>
            </div>

            <!-- SUB-TAB: AGREGAR REPARACI√ìN -->
            <div id="subtab-agregar-reparacion" class="sub-tab-contenido activo">
                <div class="formulario">
                    <h3 class="titulo-formulario">
                        <span id="tituloFormularioReparacion">üîß Agregar Nueva Reparaci√≥n</span>
                    </h3>

                    <form id="formularioReparacion" onsubmit="guardarReparacion(event)">
                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label for="repClienteNombre">Nombre del Cliente *</label>
                                <input type="text" id="repClienteNombre" placeholder="Ej: Juan P√©rez" required>
                            </div>
                            <div class="grupo-formulario">
                                <label for="repClienteTelefono">Tel√©fono del Cliente *</label>
                                <input type="tel" id="repClienteTelefono" placeholder="Ej: 3105555555" required>
                            </div>
                        </div>

                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label for="repClienteEmail">Email del Cliente</label>
                                <input type="email" id="repClienteEmail" placeholder="Ej: cliente@email.com">
                            </div>
                            <div class="grupo-formulario">
                                <label for="repClienteCedula">C√©dula del Cliente</label>
                                <input type="text" id="repClienteCedula" placeholder="Ej: 1098765432">
                            </div>
                        </div>

                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label for="repTipo">Tipo de Equipo *</label>
                                <select id="repTipo" required>
                                    <option value="">-- Selecciona --</option>
                                    <option value="Laptop">Laptop</option>
                                    <option value="Computadora">Computadora</option>
                                    <option value="Monitor">Monitor</option>
                                    <option value="Impresora">Impresora</option>
                                    <option value="Teclado">Teclado</option>
                                    <option value="Mouse">Mouse</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="grupo-formulario">
                                <label for="repEquipo">Modelo/Descripci√≥n del Equipo *</label>
                                <input type="text" id="repEquipo" placeholder="Ej: Laptop HP Pavilion 15" required>
                            </div>
                        </div>

                        <div class="fila-tres">
                            <div class="grupo-formulario">
                                <label for="repMarca">Marca</label>
                                <input type="text" id="repMarca" placeholder="Ej: HP">
                            </div>
                            <div class="grupo-formulario">
                                <label for="repModelo">Modelo</label>
                                <input type="text" id="repModelo" placeholder="Ej: Pavilion 15">
                            </div>
                            <div class="grupo-formulario">
                                <label for="repSerial">Serial/No. de Serie</label>
                                <input type="text" id="repSerial" placeholder="Ej: ABC123456">
                            </div>
                        </div>

                        <div class="grupo-formulario">
                            <label for="repFallaReportada">Falla Reportada *</label>
                            <textarea id="repFallaReportada" placeholder="Describe la falla o problema" rows="3" required></textarea>
                        </div>

                        <div class="fila-dos">
                            <div class="grupo-formulario">
                                <label for="repTecnico">T√©cnico Asignado</label>
                                <select id="repTecnico">
                                    <option value="">-- Sin asignar --</option>
                                </select>
                            </div>
                            <div class="grupo-formulario">
                                <label for="repFechaEntrega">Fecha Estimada de Entrega</label>
                                <input type="date" id="repFechaEntrega">
                            </div>
                        </div>

                        <div class="botones-formulario">
                            <button type="submit" class="btn btn-primario btn-grande">üíæ Guardar Reparaci√≥n</button>
                            <button type="button" class="btn btn-secundario" onclick="limpiarFormularioReparacion()">üîÑ Limpiar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- SUB-TAB: LISTA DE REPARACIONES -->
            <div id="subtab-lista-reparaciones" class="sub-tab-contenido">
                <div class="filtro-busqueda">
                    <input 
                        type="text" 
                        id="buscadorReparaciones" 
                        placeholder="üîç Buscar por cliente, orden o equipo..."
                        onkeyup="filtrarTablaReparaciones()"
                    >
                    <select id="filtroEstadoReparacion" onchange="filtrarTablaReparaciones()" title="Filtrar por estado">
                        <option value="">üìä Todos los estados</option>
                        <option value="Recibido">Recibido</option>
                        <option value="Diagn√≥stico">Diagn√≥stico</option>
                        <option value="En Reparaci√≥n">En Reparaci√≥n</option>
                        <option value="Listo">Listo</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                </div>

                <table class="tabla tabla-productos">
                    <thead>
                        <tr>
                            <th>Orden</th>
                            <th>Cliente</th>
                            <th>Equipo</th>
                            <th>Estado</th>
                            <th>Fecha Ingreso</th>
                            <th>T√©cnico</th>
                            <th class="acciones-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="reparacionesTabla">
                        <tr>
                            <td colspan="7" class="sin-datos">Cargando reparaciones...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- SUB-TAB: T√âCNICOS -->
            <div id="subtab-tecnicos" class="sub-tab-contenido">
                <div class="formulario">
                    <h3 class="titulo-formulario">üë®‚Äçüîß Gesti√≥n de T√©cnicos</h3>

                    <div class="fila-dos">
                        <div class="grupo-formulario">
                            <label for="tecNombre">Nombre del T√©cnico *</label>
                            <input type="text" id="tecNombre" placeholder="Ej: Michael Rodr√≠guez" required>
                        </div>
                        <div class="grupo-formulario">
                            <label for="tecTelefono">Tel√©fono</label>
                            <input type="tel" id="tecTelefono" placeholder="Ej: 3201234567">
                        </div>
                    </div>

                    <div class="grupo-formulario">
                        <label for="tecEmail">Email</label>
                        <input type="email" id="tecEmail" placeholder="Ej: tecnico@email.com">
                    </div>

                    <button class="btn btn-primario" onclick="agregarTecnico()">‚ûï Agregar T√©cnico</button>

                    <h4 class="titulo-categorias">T√©cnicos Registrados</h4>
                    <div id="listaTecnicos" class="lista-categorias">
                        <p class="sin-datos">Cargando t√©cnicos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA: CONFIGURACI√ìN -->
        <div id="tab-configuracion" class="tab-contenido">
            <h2 class="seccion-titulo">Configuraci√≥n del Sistema</h2>

            <div class="formulario">
                <h3 class="titulo-formulario">‚è∞ Configuraci√≥n de Horarios POS</h3>
                <p>Controla los horarios permitidos para iniciar y cerrar el d√≠a de trabajo en el punto de venta.</p>

                <div class="grupo-formulario">
                    <label for="cfgControlHorarios">
                        <input type="checkbox" id="cfgControlHorarios"> Activar Control de Horarios
                    </label>
                    <p class="ayuda-texto">Si est√° activado, solo se podr√° iniciar/cerrar la caja dentro de los horarios definidos.</p>
                </div>

                <div class="fila-dos">
                    <div class="grupo-formulario">
                        <label for="cfgHoraMinInicio">Hora M√≠nima de Inicio</label>
                        <input type="time" id="cfgHoraMinInicio" value="08:00">
                        <p class="ayuda-texto">No se puede iniciar antes de esta hora</p>
                    </div>
                    <div class="grupo-formulario">
                        <label for="cfgHoraMaxInicio">Hora M√°xima de Inicio</label>
                        <input type="time" id="cfgHoraMaxInicio" value="08:30">
                        <p class="ayuda-texto">No se puede iniciar despu√©s de esta hora</p>
                    </div>
                </div>

                <div class="grupo-formulario">
                    <label for="cfgHoraMinCierre">Hora M√≠nima para Cerrar</label>
                    <input type="time" id="cfgHoraMinCierre" value="17:00">
                    <p class="ayuda-texto">No se puede cerrar antes de esta hora</p>
                </div>

                <div class="botones-formulario">
                    <button class="btn btn-primario" onclick="guardarConfiguracionHorarios()">üíæ Guardar Horarios</button>
                    <button class="btn btn-secundario" onclick="cargarConfiguracionHorarios()">üîÑ Cargar Valores</button>
                </div>

                <hr>

                <h3 class="titulo-formulario">Ajustes Generales</h3>

                <div class="grupo-formulario">
                    <label for="cfgSiteName">Nombre del Sitio</label>
                    <input type="text" id="cfgSiteName" placeholder="Nombre de la ferreter√≠a">
                </div>

                <div class="fila-dos">
                    <div class="grupo-formulario">
                        <label for="cfgVersion">Versi√≥n</label>
                        <input type="text" id="cfgVersion">
                    </div>
                    <div class="grupo-formulario">
                        <label for="cfgCurrency">Moneda</label>
                        <input type="text" id="cfgCurrency" placeholder="COP">
                    </div>
                </div>

                <div class="botones-formulario">
                    <button class="btn btn-primario" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
                    <button class="btn btn-secundario" onclick="cargarConfiguracion()">üîÑ Cargar Valores</button>
                </div>

                <hr>

                <h3 class="titulo-formulario">Seguridad</h3>
                <p>Gestiona la cuenta administrativa y el estado de la base de datos.</p>

                <div class="fila-dos">
                    <div>
                        <!-- <button class="btn btn-primario" onclick="document.getElementById('modalCambiarPass').classList.add('activo')">üîë Cambiar Contrase√±a Admin</button> -->
                    </div>
                    <div>
                        <!-- <button class="btn btn-secundario" disabled  onclick="window.open('/api/db/export', '_blank')">üìÑ Exportar DB</button> -->
                      <!-- <button class="btn btn-peligro" disabled onclick="resetearBaseDatos()">‚ö†Ô∏è Resetear Base de Datos</button> -->

                    </div>
                </div>

                <hr>

                <div class="caja-info">
                    <p class="caja-titulo">‚ÑπÔ∏è Informaci√≥n T√©cnica:</p>
                    <ul class="lista-info">
                        <li><strong>Usuario Actual:</strong> <span id="infoUsuarioActual">-</span></li>
                        <li><strong>Versi√≥n:</strong> <span id="infoVersion">-</span></li>
                        <li><strong>Base de Datos:</strong> <code>db.json</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL EDITAR PRODUCTO -->
    <div class="modal" id="modalEditarProducto">
        <div class="modal-contenido">
            <h2 class="modal-titulo">Editar Producto</h2>

            <form id="formularioEditar" onsubmit="guardarProducto(event, true)">
                <div class="grupo-formulario">
                    <label for="editNombre">Nombre *</label>
                    <input type="text" id="editNombre" required>
                </div>

                <div class="grupo-formulario">
                    <label for="editCategoria">Categor√≠a *</label>
                    <select id="editCategoria" required>
                        <option value="">-- Selecciona categor√≠a --</option>
                    </select>
                </div>

                <div class="grupo-formulario">
                    <label for="editDescripcion">Descripci√≥n</label>
                    <textarea id="editDescripcion"></textarea>
                </div>

                <div class="fila-dos">
                    <div class="grupo-formulario">
                        <label for="editStock">Stock (unidades) *</label>
                        <input type="number" id="editStock" min="0" required>
                    </div>
                    <div class="grupo-formulario">
                        <label for="editPrecio">Precio Unitario ($) *</label>
                        <input type="number" id="editPrecio" min="0" step="0.01" required>
                    </div>
                </div>

                <div class="grupo-formulario">
                    <label for="editImagen">URL de Imagen</label>
                    <input type="url" id="editImagen">
                </div>

                <div class="modal-botones">
                    <button type="button" class="btn btn-secundario" onclick="cerrarModalEditar()">Cancelar</button>
                    <button type="submit" class="btn btn-primario">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL VER DETALLES VENTA -->
    <div class="modal" id="modalDetallesVenta">
        <div class="modal-contenido">
            <h2 class="modal-titulo">Detalles de la Venta</h2>
            <div id="detallesVentaContenido"></div>
            <div class="modal-botones">
                <button class="btn btn-secundario" onclick="cerrarModalVenta()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // ====================================================================
        // VARIABLES GLOBALES
        // ====================================================================

        let productoActualEdicion = null;
        let productosCompletos = [];
        let ventasCompletas = [];
        let productosTab = [];
        let ventasTab = [];
        // Lista de categor√≠as mantenida en memoria (no persiste en servidor)
        let categoriasDisponibles = [];

        // ====================================================================
        // INICIALIZACI√ìN
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            verificarSesionAlCarga();
        });

        /**
         * Verifica si hay sesi√≥n activa al cargar la p√°gina
         */
        async function verificarSesionAlCarga() {
            try {
                const respuesta = await fetch('/api/verificar-sesion');
                const datos = await respuesta.json();

                if (datos.autenticado) {
                    // Ya hay sesi√≥n, mostrar panel
                    mostrarPanel(datos.usuario);
                } else {
                    // No hay sesi√≥n, mostrar login
                    mostrarLogin();
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
                mostrarLogin();
            }
        }

        /**
         * Muestra el formulario de login
         */
        function mostrarLogin() {
            document.getElementById('modalLogin').classList.remove('cerrado');
            document.getElementById('encabezado').classList.add('oculto');
            document.querySelector('main').style.display = 'none';
        }

        /**
         * Muestra el panel administrativo
         */
        function mostrarPanel(usuario) {
            document.getElementById('modalLogin').classList.add('cerrado');
            document.getElementById('encabezado').classList.remove('oculto');
            document.querySelector('main').style.display = 'block';
            document.getElementById('usuarioActual').textContent = usuario;

            // Cargar datos
            cargarProductos();
            cargarVentas();
            cargarCategorias();
            cargarConfiguracion();
            cargarConfiguracionHorarios();

            // Actualizar contador de stock bajo
            updateStockBajoBadge();

            // Mostrar primero la pesta√±a de Analytics
            cambiarTab('analytics');
        }

        /**
         * Maneja el inicio de sesi√≥n
         */
        async function iniciarSesion(event) {
            event.preventDefault();

            const usuario = document.getElementById('usuarioLogin').value.trim();
            const password = document.getElementById('passwordLogin').value;
            const btnLogin = document.getElementById('btnLogin');
            const mensajeError = document.getElementById('mensajeLoginError');

            // Validar campos
            if (!usuario || !password) {
                mostrarErrorLogin('Ingresa usuario y contrase√±a');
                return;
            }

            // Mostrar estado de carga
            btnLogin.disabled = true;
            btnLogin.classList.add('cargando');
            mensajeError.classList.remove('mostrar');

            try {
                const respuesta = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario, password })
                });

                const datos = await respuesta.json();

                if (!respuesta.ok) {
                    // Error de autenticaci√≥n
                    mostrarErrorLogin(datos.error || 'Credenciales inv√°lidas');
                    btnLogin.disabled = false;
                    btnLogin.classList.remove('cargando');
                    return;
                }

                // Login exitoso - mostrar animaci√≥n de √©xito
                btnLogin.classList.remove('cargando');
                btnLogin.textContent = '‚úì Accediendo...';
                await new Promise(resolve => setTimeout(resolve, 500));

                // Mostrar panel
                mostrarPanel(datos.usuario);
                document.getElementById('formularioLogin').reset();

            } catch (error) {
                mostrarErrorLogin('Error al conectar con el servidor');
                btnLogin.disabled = false;
                btnLogin.classList.remove('cargando');
                console.error('Error en login:', error);
            }
        }

        function mostrarErrorLogin(mensaje) {
            const mensajeError = document.getElementById('mensajeLoginError');
            mensajeError.textContent = '‚ö†Ô∏è ' + mensaje;
            mensajeError.classList.add('mostrar');
            // Auto-hide despu√©s de 5 segundos
            setTimeout(() => {
                mensajeError.classList.remove('mostrar');
            }, 5000);
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('passwordLogin');
            const btn = document.querySelector('.btn-show-password');
            
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        /**
         * Carga los productos desde el servidor
         */
        async function cargarProductos() {
            try {
                const respuesta = await fetch('/api/productos');
                productosCompletos = await respuesta.json();
                productosTab = [...productosCompletos];
                mostrarProductosTabla();
            } catch (error) {
                mostrarMensaje('Error al cargar productos: ' + error.message, 'error');
            }
        }

        /**
         * Carga las ventas desde el servidor
         */
        async function cargarVentas() {
            try {
                const respuesta = await fetch('/api/ventas', {
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!respuesta.ok) {
                    throw new Error('No autorizado');
                }

                ventasCompletas = await respuesta.json();
                ventasTab = [...ventasCompletas];
                mostrarEstadisticasVentas();
                mostrarVentasTabla();
            } catch (error) {
                mostrarMensaje('Error al cargar ventas: ' + error.message, 'error');
            }
        }

        // ====================================================================
        // GESTI√ìN DE D√çAS - ADMIN
        // ====================================================================

        function abrirModalDias() {
            document.getElementById('modalDias').classList.add('activo');
            cargarDias();
        }

        function cerrarModalDias() {
            document.getElementById('modalDias').classList.remove('activo');
        }

        async function cargarDias() {
            try {
                const resp = await fetch('/api/dias', { headers: { 'Content-Type': 'application/json' } });
                if (!resp.ok) throw new Error('No autorizado');
                const dias = await resp.json();
                const cont = document.getElementById('contenidoDias');
                if (!Array.isArray(dias) || dias.length === 0) {
                    cont.innerHTML = '<p>No hay registros de d√≠as.</p>';
                    return;
                }

                cont.innerHTML = `
                    <table class="tabla" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Inicio</th>
                                <th>Cierre</th>
                                <th>Estado</th>
                                <th>Ventas</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dias.map(d => `
                                <tr>
                                    <td>${d.fecha}</td>
                                    <td>${d.inicio ? new Date(d.inicio).toLocaleString('es-CO') : '-'}</td>
                                    <td>${d.cierre ? new Date(d.cierre).toLocaleString('es-CO') : '-'}</td>
                                    <td>${d.estado}</td>
                                    <td>${(d.ventas || []).length}</td>
                                    <td>${d.total != null ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(d.total) : '-'}</td>
                                    <td><button class="btn btn-peque√±o btn-primario" onclick="verDetalleDia('${d.id}')">Ver</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (err) {
                console.error('Error cargando d√≠as:', err);
                document.getElementById('contenidoDias').innerHTML = '<p>Error cargando d√≠as</p>';
            }
        }

        async function verDetalleDia(id) {
            try {
                const resp = await fetch(`/api/dias/${id}`, { headers: { 'Content-Type': 'application/json' } });
                if (!resp.ok) throw new Error('No encontrado');
                const dia = await resp.json();
                const cont = document.getElementById('contenidoDias');

                cont.innerHTML = `
                    <h3>D√≠a: ${dia.fecha} ‚Äî Estado: ${dia.estado}</h3>
                    <p>Inicio: ${dia.inicio ? new Date(dia.inicio).toLocaleString('es-CO') : '-'}<br>Cierre: ${dia.cierre ? new Date(dia.cierre).toLocaleString('es-CO') : '-'}</p>
                    <h4>Ventas (${Array.isArray(dia.ventas) ? dia.ventas.length : 0})</h4>
                    <div style="max-height:360px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:8px; background:#fff;">
                        ${(dia.ventas && dia.ventas.length > 0) ? dia.ventas.map(v => `
                            <div style="padding:6px 8px; border-bottom:1px solid #f3f3f3; display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div><strong>ID:</strong> <code>${v.id}</code></div>
                                    <div><strong>Cliente:</strong> ${v.cliente?.nombre || 'Cliente'}</div>
                                    <div style="font-size:0.9rem; color:#666">Fecha: ${new Date(v.fecha).toLocaleString('es-CO')}</div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-weight:800; color:#D64545">${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(v.total)}</div>
                                    <div style="margin-top:6px"><button class="btn btn-peque√±o" onclick="verDetallesVenta('${v.id}')">Ver factura</button></div>
                                </div>
                            </div>
                        `).join('') : '<p>No hay ventas para este d√≠a.</p>'}
                    </div>
                    <div style="margin-top:12px; font-weight:800;">Total del d√≠a: ${dia.total != null ? new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(dia.total) : '-'}</div>
                    <div style="margin-top:10px; text-align:right;"></div>
                `;

            } catch (err) {
                console.error('Error detalle d√≠a:', err);
                document.getElementById('contenidoDias').innerHTML = '<p>Error obteniendo detalles del d√≠a</p>';
            }
        }

        // ====================================================================
        // GESTI√ìN DE TABS
        // ====================================================================

        /**
         * Cambia entre tabs
         */
        function cambiarTab(nombreTab) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-contenido').forEach(tab => {
                tab.classList.remove('activo');
            });

            // Desactivar items del sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('activo');
            });

            // Desactivar botones de categor√≠a
            document.querySelectorAll('.nav-category-btn').forEach(btn => {
                btn.classList.remove('activo');
            });

            // Ocultar submen√∫s
            document.querySelectorAll('.nav-submenu').forEach(menu => {
                menu.classList.remove('activo');
            });

            // Mostrar tab seleccionado
            const tab = document.getElementById(`tab-${nombreTab}`);
            if (tab) tab.classList.add('activo');

            // Si es proveedores, activar la categor√≠a correspondiente
            if (nombreTab === 'proveedores') {
                let activatedCategory = false;
                const categories = document.querySelectorAll('.nav-category');
                categories.forEach(cat => {
                    if (activatedCategory) return;
                    const btn = cat.querySelector('.nav-category-btn');
                    const submenu = cat.querySelector('.nav-submenu');
                    // Comprobar texto del bot√≥n (compatibilidad con iconos/texto)
                    const texto = btn ? (btn.textContent || '').toLowerCase() : '';
                    const hasSubitem = Array.from(cat.querySelectorAll('.nav-subitem')).some(si => {
                        const onclick = si.getAttribute('onclick') || '';
                        return onclick.includes(`cambiarTab('${nombreTab}')`) || onclick.includes(`cambiarTab("${nombreTab}")`);
                    });

                    if (texto.includes('proveedor') || hasSubitem) {
                        if (btn) btn.classList.add('activo');
                        if (submenu) submenu.classList.add('activo');
                        activatedCategory = true;
                    }
                });

                // Fallback: activar la primera categor√≠a si no se encontr√≥
                if (!activatedCategory) {
                    const categoryBtn = document.querySelector('.nav-category-btn');
                    const submenu = document.querySelector('.nav-submenu');
                    if (categoryBtn) categoryBtn.classList.add('activo');
                    if (submenu) submenu.classList.add('activo');
                }
            } else {
                // Activar el item del sidebar correspondiente
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    // Primer intento: buscar data-tab
                    if (item.dataset && item.dataset.tab === nombreTab) {
                        item.classList.add('activo');
                        return;
                    }
                    // Fallback: buscar en onclick textual (compatibilidad)
                    try {
                        if (item.getAttribute && item.getAttribute('onclick') && item.getAttribute('onclick').includes(`'${nombreTab}'`)) {
                            item.classList.add('activo');
                        }
                    } catch(e) { /* ignore */ }
                });
            }

            // Recargar datos si es necesario
            if (nombreTab === 'ventas') {
                cargarVentas();
            } else if (nombreTab === 'analytics') {
                cargarVentas();
                setTimeout(() => actualizarAnalytics(), 100);
            } else if (nombreTab === 'reparaciones') {
                cargarReparaciones();
                cargarTecnicos();
            } else if (nombreTab === 'proveedores') {
                try { cargarProveedoresUI(); } catch(e) {}
            }
        }

        /**
         * Toggle sidebar en mobile
         */
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('activo');
            overlay.classList.toggle('activo');
        }

        /**
         * Cierra el sidebar
         */
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('activo');
            overlay.classList.remove('activo');
        }

        /**
         * Toggle de categor√≠as del men√∫
         */
        function toggleNavCategory(event) {
            event.preventDefault();
            const btn = event.currentTarget;
            const submenu = btn.nextElementSibling;
            
            // Cerrar otras categor√≠as
            document.querySelectorAll('.nav-category-btn').forEach(b => {
                if (b !== btn && b.classList.contains('activo')) {
                    b.classList.remove('activo');
                    b.nextElementSibling?.classList.remove('activo');
                }
            });
            
            // Toggle actual
            btn.classList.toggle('activo');
            submenu.classList.toggle('activo');
        }

        // ====================================================================
        // GESTI√ìN DE PRODUCTOS
        // ====================================================================

        /**
         * Carga la lista de productos con stock bajo desde la API
         */
        async function cargarStockBajo() {
            const umbral = parseInt(document.getElementById('umbralStockBajo')?.value || '5');
            const tbody = document.getElementById('stockBajoTabla');
            if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="sin-datos">Cargando...</td></tr>';

            try {
                const resp = await fetch(`/api/stock-bajo?umbral=${umbral}`);
                if (!resp.ok) throw new Error('Error cargando stock bajo');
                const data = await resp.json();
                mostrarStockBajo(data.productos || []);
                updateStockBajoBadge();
            } catch (err) {
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="sin-datos">Error: ${err.message}</td></tr>`;
            }
        }

        /**
         * Renderiza la tabla de stock bajo
         */
        function mostrarStockBajo(lista) {
            const tbody = document.getElementById('stockBajoTabla');
            if (!tbody) return;
            if (!lista || lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="sin-datos">No hay productos con stock bajo</td></tr>';
                return;
            }

            tbody.innerHTML = lista.map(p => `
                <tr>
                    <td><strong>${p.nombre}</strong></td>
                    <td><span class="badge-categoria">${p.categoria}</span></td>
                    <td><span class="estado-stock ${p.stock === 0 ? 'stock-agotado' : 'stock-bajo'}">${p.stock}</span></td>
                    <td class="precio-celda">$${(p.precio||0).toFixed(2)}</td>
                    <td class="acciones-celda">
                        <button class="btn btn-peque√±o btn-primario" onclick="abrirEditar('${p.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-peque√±o btn-secundario" onclick="reabastecerProducto('${p.id}')">üîÅ Reabastecer</button>
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Prompt para reabastecer y llamada al endpoint
         */
        async function reabastecerProducto(id) {
            const cantidadStr = prompt('Ingrese la cantidad a sumar al stock (n√∫mero entero):', '10');
            if (!cantidadStr) return;
            const cantidad = parseInt(cantidadStr);
            if (isNaN(cantidad) || cantidad <= 0) { alert('Cantidad inv√°lida'); return; }

            try {
                const resp = await fetch(`/api/productos/${id}/reabastecer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cantidad })
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Error reabasteciendo');
                }
                const result = await resp.json();
                alert('Reabastecido: nuevo stock = ' + result.producto.stock);
                cargarStockBajo();
                updateStockBajoBadge();
                cargarProductos();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        /**
         * Actualiza el badge en la navegaci√≥n con la cantidad de productos en stock bajo
         */
        async function updateStockBajoBadge() {
            try {
                const umbralEl = document.getElementById('umbralStockBajo');
                const umbral = umbralEl ? parseInt(umbralEl.value || '5') : 5;
                const resp = await fetch(`/api/stock-bajo?umbral=${umbral}`);
                if (!resp.ok) return;
                const data = await resp.json();
                const badge = document.getElementById('badgeStockBajo');
                if (badge) {
                    badge.textContent = data.count || 0;
                    badge.style.display = (data.count && data.count > 0) ? 'inline-block' : 'none';
                }
            } catch (e) {
                // silent
            }
        }

        /**
         * Genera un pedido de compra (CSV) a partir de los productos en stock-bajo
         */
        async function crearPedidoCompra() {
            const umbral = parseInt(document.getElementById('umbralStockBajo')?.value || '5');
            try {
                const resp = await fetch(`/api/stock-bajo?umbral=${umbral}`);
                if (!resp.ok) throw new Error('No se pudo obtener productos');
                const data = await resp.json();
                const lista = data.productos || [];
                if (!lista || lista.length === 0) {
                    alert('No hay productos por debajo del umbral para crear un pedido.');
                    return;
                }

                // Cargar proveedores para mostrar en el formulario
                await cargarProveedoresUI();

                // Crear filas con cantidad sugerida = (umbral*2 - stock) m√≠nimo 1
                const filas = lista.map(p => {
                    const sugerido = Math.max(1, (umbral * 2) - (parseInt(p.stock||0)) );
                    return {
                        id: p.id,
                        nombre: p.nombre,
                        categoria: p.categoria || '',
                        stock: p.stock || 0,
                        precio: p.precio || 0,
                        sugerido
                    };
                });

                // Navegar a pesta√±a de √ìrdenes de Proveedores para crear orden desde all√≠
                cambiarTab('proveedores');
                cambiarSubTab('prov-ordenes');
                
                // Cargar datos necesarios
                await cargarSelectoOrdenes();
                await cargarOrdenesCompra();

                // Pre-llenar el formulario con los productos sugeridos
                const contenedor = document.getElementById('ordenProductos');
                if (contenedor) {
                    // Limpiar filas existentes excepto la primera
                    const filas_actuales = contenedor.querySelectorAll('.fila-orden');
                    for (let i = filas_actuales.length - 1; i > 0; i--) {
                        filas_actuales[i].remove();
                    }

                    // Agregar productos al formulario
                    lista.forEach((prod, idx) => {
                        const fila = idx === 0 ? contenedor.querySelector('.fila-orden') : crearFilaProductoOrden();
                        if (fila) {
                            const select = fila.querySelector('.select-producto');
                            const inputCant = fila.querySelector('.input-cantidad');
                            const inputCosto = fila.querySelector('.input-costo');
                            
                            if (select) {
                                select.value = prod.id;
                                select.dispatchEvent(new Event('change'));
                            }
                            if (inputCant) {
                                inputCant.value = Math.max(1, (umbral * 2) - parseInt(prod.stock || 0));
                            }
                            if (inputCosto) {
                                inputCosto.value = prod.precio || 0;
                            }
                        }
                    });
                }

                // Mostrar mensaje informativo
                const msg = document.createElement('div');
                msg.style.cssText = 'background: #d4edda; color: #155724; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #c3e6cb;';
                msg.innerHTML = '‚úÖ <strong>Productos con stock bajo detectados</strong><br>Ajusta los detalles y selecciona un proveedor para crear la orden.';
                const panel = document.querySelector('.orden-form-panel');
                if (panel && !document.getElementById('msgStockBajo')) {
                    msg.id = 'msgStockBajo';
                    panel.insertBefore(msg, panel.querySelector('form'));
                    setTimeout(() => msg.remove(), 8000);
                }

                alert('‚úÖ Formulario pre-cargado con productos de stock bajo. Selecciona proveedor y ajusta cantidades.');
            } catch (err) {
                alert('Error creando pedido: ' + err.message);
            }
        }

    
        async function cargarProveedores() {
            try {
                const r = await fetch('/api/proveedores', { credentials: 'same-origin' });
                if (!r.ok) {
                    let msg = 'No se pudo cargar proveedores';
                    try { const j = await r.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await r.text(); } catch(e) {} }
                    throw new Error(msg);
                }
                let lista = [];
                try { lista = await r.json(); } catch(e) { lista = []; }
                const sel = document.getElementById('selectProveedorPedido');
                if (!sel) return;
                sel.innerHTML = '<option value="">Seleccionar proveedor (opcional)</option>';
                lista.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.textContent = p.nombre || p.razon || ('Proveedor ' + p.id);
                    sel.appendChild(opt);
                });
            } catch (e) {
                console.error('No se pudo cargar proveedores', e);
            }
        }

        async function guardarPedidoServidor() {
            const container = document.getElementById('modalPedidoContent');
            if (!container) return alert('No hay pedido para guardar');
            const objStr = container.dataset.obj;
            if (!objStr) return alert('No hay pedido generado');
            const proveedorId = document.getElementById('selectProveedorPedido')?.value || null;
            const body = JSON.parse(objStr);
            body.proveedorId = proveedorId;
            try {
                const res = await fetch('/api/pedidos', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    let msg = 'Error guardando pedido';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }
                let data = {};
                try { data = await res.json(); } catch(e) { data = {}; }
                container.dataset.pedidoId = data.id;
                alert('Pedido guardado: ' + data.id);
                cerrarModalPedido();
                try { updateStockBajoBadge(); cargarProductos(); } catch(e) {}
            } catch (e) {
                console.error(e);
                alert('Error guardando pedido: ' + e.message);
            }
        }

        let proveedoresList = [];

        async function cargarProveedoresUI() {
            try {
                const resp = await fetch('/api/proveedores', { credentials: 'same-origin' });
                if (!resp.ok) {
                    // intentar leer mensaje JSON, si no, texto plano
                    let msg = 'No autorizado o error al cargar';
                    try { const j = await resp.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await resp.text(); } catch(e) {} }
                    throw new Error(msg);
                }
                try {
                    proveedoresList = await resp.json();
                } catch (e) {
                    // si el servidor devolvi√≥ HTML u otro, mostrar vac√≠o
                    proveedoresList = [];
                }
                mostrarProveedores();
                // tambi√©n actualizar selector en stock-bajo
                try { cargarProveedores(); } catch(e) {}
            } catch (e) {
                const tbody = document.getElementById('proveedoresTabla');
                if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="sin-datos">Error: ${e.message}</td></tr>`;
            }
        }

        function mostrarProveedores(filter = '') {
            const tbody = document.getElementById('proveedoresTabla');
            if (!tbody) return;
            
            const q = (filter || document.getElementById('buscadorProveedores')?.value || '').toLowerCase();
            const ciudad = document.getElementById('filtCiudad')?.value?.toLowerCase() || '';
            const categoria = document.getElementById('filtCategoria')?.value?.toLowerCase() || '';
            
            let lista = (proveedoresList || []).filter(p => {
                const matchNombre = p.nombre.toLowerCase().includes(q) || (p.nit||'').toLowerCase().includes(q) || (p.contacto||'').toLowerCase().includes(q) || (p.email||'').toLowerCase().includes(q);
                const matchCiudad = !ciudad || (p.ciudad||'').toLowerCase().includes(ciudad);
                const matchCat = !categoria || (p.categorias||'').toLowerCase().includes(categoria);
                return matchNombre && matchCiudad && matchCat;
            });

            // Contar √≥rdenes por proveedor
            const ordenesXProv = {};
            (ordenesCompraList || []).forEach(o => {
                ordenesXProv[o.proveedor_id] = (ordenesXProv[o.proveedor_id] || 0) + 1;
            });
            
            if (!lista || lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="sin-datos">No hay proveedores</td></tr>';
            } else {
                tbody.innerHTML = lista.map(p => `
                    <tr>
                        <td><strong>${escapeHtml(p.nombre)}</strong></td>
                        <td><code>${escapeHtml(p.nit || 'N/A')}</code></td>
                        <td>${escapeHtml(p.contacto || '-')}</td>
                        <td><a href="tel:${p.telefono}">${escapeHtml(p.telefono || '-')}</a></td>
                        <td><a href="mailto:${p.email}">${escapeHtml(p.email || '-')}</a></td>
                        <td>${escapeHtml(p.ciudad || '-')}</td>
                        <td style="text-align: center;"><span class="badge-cantidad">${ordenesXProv[p.id] || 0}</span></td>
                        <td class="acciones-celda">
                            <button class="btn btn-peque√±o btn-info" onclick="verProveedorDetalle('${p.id}')" title="Ver">üëÅÔ∏è</button>
                            <button class="btn btn-peque√±o btn-primario" onclick="abrirEditarProveedor('${p.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-peque√±o btn-peligro" onclick="eliminarProveedor('${p.id}')" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Actualizar resumen
            document.getElementById('totalProveedores').textContent = lista.length;
            document.getElementById('proveedoresActivos').textContent = lista.length;
            
            const ordActivas = (ordenesCompraList || []).filter(o => ['pendiente', 'en_proceso'].includes(o.estado)).length;
            document.getElementById('totalOrdenes').textContent = ordActivas;
        }

        function mostrarFiltrosAvanzados() {
            const div = document.getElementById('filtrosAvanzados');
            if (div.style.display === 'none') {
                div.style.display = 'block';
            } else {
                div.style.display = 'none';
            }
        }

        function exportarProveedores() {
            const lista = proveedoresList || [];
            let csv = 'Nombre,NIT,Contacto,Tel√©fono,Email,Ciudad,Direcci√≥n\n';
            lista.forEach(p => {
                csv += `"${p.nombre}","${p.nit||''}","${p.contacto||''}","${p.telefono||''}","${p.email||''}","${p.ciudad||''}","${p.direccion||''}"\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proveedores_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function verProveedorDetalle(id) {
            const prov = (proveedoresList || []).find(p => p.id === id);
            if (!prov) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'modalProvDetalle';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-pro modal-max-500">
                    <div class="modal-header-pro">
                        <h2>${escapeHtml(prov.nombre)}</h2>
                        <button class="modal-close-pro" onclick="cerrarModal('modalProvDetalle')">‚úï</button>
                    </div>
                    <div class="modal-body-pro">
                        <div class="detalle-grupo">
                            <label>NIT/C√©dula</label>
                            <p>${escapeHtml(prov.nit || 'N/A')}</p>
                        </div>
                        <div class="detalle-grupo">
                            <label>Contacto</label>
                            <p>${escapeHtml(prov.contacto || '-')}</p>
                        </div>
                        <div class="detalle-grupo">
                            <label>Tel√©fono</label>
                            <p><a href="tel:${prov.telefono}">${escapeHtml(prov.telefono || '-')}</a> ${prov.telefono2 ? `/ <a href="tel:${prov.telefono2}">${escapeHtml(prov.telefono2)}</a>` : ''}</p>
                        </div>
                        <div class="detalle-grupo">
                            <label>Email</label>
                            <p><a href="mailto:${prov.email}">${escapeHtml(prov.email || '-')}</a></p>
                        </div>
                        <div class="detalle-grupo">
                            <label>Ubicaci√≥n</label>
                            <p>${escapeHtml(prov.ciudad || '-')} - ${escapeHtml(prov.direccion || '-')}</p>
                        </div>
                        <div class="detalle-grupo">
                            <label>Categor√≠as</label>
                            <p>${escapeHtml(prov.categorias || '-')}</p>
                        </div>
                        <div class="detalle-grupo">
                            <label>M√©todos de Pago</label>
                            <p>${escapeHtml(prov.metodos_pago || '-')}</p>
                        </div>
                        ${prov.notas ? `<div class="detalle-grupo"><label>Observaciones</label><p>${escapeHtml(prov.notas)}</p></div>` : ''}
                    </div>
                    <div class="modal-footer-pro">
                        <button class="btn btn-primario" onclick="abrirEditarProveedor('${id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-secundario" onclick="cerrarModal('modalProvDetalle')">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function filtrarProveedores() { mostrarProveedores(); }

        function limpiarFormularioProveedor() {
            document.getElementById('provId').value = '';
            document.getElementById('provNombre').value = '';
            document.getElementById('provNIT').value = '';
            document.getElementById('provContacto').value = '';
            document.getElementById('provTelefono').value = '';
            document.getElementById('provTelefono2').value = '';
            document.getElementById('provEmail').value = '';
            document.getElementById('provDireccion').value = '';
            document.getElementById('provCiudad').value = '';
            document.getElementById('provCategorias').value = '';
            document.getElementById('provPagos').value = '';
            document.getElementById('provNotas').value = '';
        }

        function abrirFormularioNuevoProveedor() {
            limpiarFormularioProveedor();
            document.getElementById('provId').value = '';
            const titulo = document.getElementById('formTitulo');
            if (titulo) titulo.textContent = '‚ûï Nuevo Proveedor';
            cambiarSubTab('prov-agregar');
            // Mostrar con scroll al formulario
            setTimeout(() => {
                const form = document.getElementById('subtab-prov-agregar');
                if (form) form.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        async function guardarProveedor(event) {
            event.preventDefault();
            const id = document.getElementById('provId').value || null;
            const body = {
                nombre: document.getElementById('provNombre').value,
                nit: document.getElementById('provNIT').value,
                contacto: document.getElementById('provContacto').value,
                telefono: document.getElementById('provTelefono').value,
                telefono2: document.getElementById('provTelefono2').value,
                email: document.getElementById('provEmail').value,
                direccion: document.getElementById('provDireccion').value,
                ciudad: document.getElementById('provCiudad').value,
                categorias: document.getElementById('provCategorias').value,
                metodos_pago: document.getElementById('provPagos').value,
                notas: document.getElementById('provNotas').value,
                estado: (document.getElementById('provEstado') ? document.getElementById('provEstado').value : 'Activo')
            };
            try {
                const btn = event?.submitter || document.querySelector('#formularioProveedor button[type="submit"]');
                if (btn) { btn.disabled = true; btn.textContent = 'Guardando...'; }
                let res;
                if (id) {
                    res = await fetch(`/api/proveedores/${id}`, { method: 'PUT', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                } else {
                    res = await fetch('/api/proveedores', { method: 'POST', credentials: 'same-origin', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                }
                if (!res.ok) {
                    let message = 'Error guardando proveedor';
                    try { const j = await res.json(); message = j.error || j.message || message; } catch(e) { try { message = await res.text(); } catch(e) {} }
                    throw new Error(message);
                }
                let saved = {};
                try { saved = await res.json(); } catch(e) { saved = {}; }
                await cargarProveedoresUI();
                await cargarSelectoOrdenes();
                limpiarFormularioProveedor();
                cambiarSubTab('prov-lista');
                // Mostrar fecha de creaci√≥n si el servidor la devolvi√≥
                if (saved && saved.fechaCreacion) {
                    const fc = document.getElementById('provFechaCreacion'); if (fc) fc.textContent = saved.fechaCreacion;
                }
                alert('Proveedor guardado correctamente');
                if (btn) { btn.disabled = false; btn.textContent = 'üíæ Guardar'; }
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
                const btn = document.querySelector('#formularioProveedor button[type="submit"]');
                if (btn) { btn.disabled = false; btn.textContent = 'üíæ Guardar'; }
            }
        }

        async function abrirEditarProveedor(id) {
            try {
                const res = await fetch(`/api/proveedores/${id}`, { credentials: 'same-origin' });
                if (!res.ok) {
                    let msg = 'No se pudo obtener proveedor';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }
                let p = {};
                try { p = await res.json(); } catch(e) { p = {}; }
                document.getElementById('provId').value = p.id;
                document.getElementById('provNombre').value = p.nombre || '';
                document.getElementById('provNIT').value = p.nit || '';
                document.getElementById('provContacto').value = p.contacto || '';
                document.getElementById('provTelefono').value = p.telefono || '';
                document.getElementById('provTelefono2').value = p.telefono2 || '';
                document.getElementById('provEmail').value = p.email || '';
                document.getElementById('provDireccion').value = p.direccion || '';
                document.getElementById('provCiudad').value = p.ciudad || '';
                document.getElementById('provCategorias').value = p.categorias || '';
                document.getElementById('provPagos').value = p.metodos_pago || '';
                document.getElementById('provNotas').value = p.notas || '';
                if (document.getElementById('provEstado')) document.getElementById('provEstado').value = p.estado || 'Activo';
                const fc = document.getElementById('provFechaCreacion'); if (fc) fc.textContent = p.fechaCreacion || '(se genera al guardar)';
                cambiarTab('proveedores');
                cambiarSubTab('prov-agregar');
            } catch (e) { console.error(e); alert('Error cargando proveedor'); }
        }

        async function eliminarProveedor(id) {
            if (!confirm('¬øEliminar proveedor? Esta acci√≥n es irreversible.')) return;
            try {
                const res = await fetch(`/api/proveedores/${id}`, { method: 'DELETE', credentials: 'same-origin' });
                if (!res.ok) {
                    let msg = 'Error eliminando';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }
                await cargarProveedoresUI();
                alert('Proveedor eliminado');
            } catch (e) { console.error(e); alert('Error: ' + e.message); }
        }

        // ========== FUNCIONES √ìRDENES DE COMPRA ==========
        let ordenesCompraList = [];

        async function cargarSelectoOrdenes() {
            try {
                const resp = await fetch('/api/proveedores', { credentials: 'same-origin' });
                if (!resp.ok) return;
                const provs = await resp.json();
                const select = document.getElementById('ordenProveedor');
                if (select) {
                    const val = select.value;
                    select.innerHTML = '<option value="">Seleccionar proveedor...</option>';
                    provs.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.nombre;
                        select.appendChild(opt);
                    });
                    select.value = val || '';
                }
                cargarSelectoProductos();
            } catch (e) { console.error('Error cargando proveedores para orden:', e); }
        }

        function cargarSelectoProductos() {
            const selectos = document.querySelectorAll('.select-producto');
            selectos.forEach(sel => {
                const val = sel.value;
                sel.innerHTML = '<option value="">Agregar producto...</option>';
                (productosTab || []).forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = JSON.stringify({id: p.id, nombre: p.nombre, precio: p.precio});
                    opt.textContent = `${p.nombre} ($${p.precio})`;
                    sel.appendChild(opt);
                });
                sel.value = val || '';
            });
        }

        function crearFilaProductoOrden() {
            const div = document.getElementById('ordenProductos');
            const fila = document.createElement('div');
            fila.className = 'fila-orden';
            fila.innerHTML = `
                <select class="select-producto" onchange="calcularTotalOrden()">
                    <option value="">Agregar producto...</option>
                </select>
                <input type="number" placeholder="Cantidad" min="1" class="input-cantidad" onchange="calcularTotalOrden()">
                <input type="number" placeholder="Costo unitario" min="0" step="0.01" class="input-costo" onchange="calcularTotalOrden()">
                <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProductoOrden(this)">üóëÔ∏è</button>
            `;
            div.appendChild(fila);
            cargarSelectoProductos();
            return fila;
        }

        function agregarFilaProductoOrden() {
            crearFilaProductoOrden();
        }

        function eliminarProductoOrden(btn) {
            btn.parentElement.remove();
            calcularTotalOrden();
        }

        function calcularTotalOrden() {
            let total = 0;
            const filas = document.querySelectorAll('#ordenProductos .fila-orden');
            filas.forEach(fila => {
                const cant = parseFloat(fila.querySelector('.input-cantidad').value) || 0;
                const costo = parseFloat(fila.querySelector('.input-costo').value) || 0;
                total += cant * costo;
            });
            const totalInput = document.getElementById('ordenTotal');
            if (totalInput) {
                totalInput.value = `$${total.toLocaleString('es-CO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }
        }

        function limpiarFormularioOrden() {
            document.getElementById('formularioOrden').reset();
            const div = document.getElementById('ordenProductos');
            if (div) div.innerHTML = `
                <div class="fila-orden">
                    <select class="select-producto" onchange="calcularTotalOrden()">
                        <option value="">Agregar producto...</option>
                    </select>
                    <input type="number" placeholder="Cantidad" min="1" class="input-cantidad" onchange="calcularTotalOrden()">
                    <input type="number" placeholder="Costo unitario" min="0" step="0.01" class="input-costo" onchange="calcularTotalOrden()">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProductoOrden(this)">üóëÔ∏è</button>
                </div>
            `;
            cargarSelectoProductos();
            document.getElementById('ordenTotal').value = '$0.00';
        }

        async function guardarOrdenCompra(event) {
            event.preventDefault();
            const provId = document.getElementById('ordenProveedor').value;
            if (!provId) { alert('Selecciona un proveedor'); return; }

            const detalles = [];
            const filas = document.querySelectorAll('#ordenProductos .fila-orden');
            if (filas.length === 0) { alert('Agrega al menos un producto'); return; }

            filas.forEach(fila => {
                const selectVal = fila.querySelector('.select-producto').value;
                if (!selectVal) return;
                try {
                    const prod = JSON.parse(selectVal);
                    const cant = parseInt(fila.querySelector('.input-cantidad').value) || 0;
                    const costo = parseFloat(fila.querySelector('.input-costo').value) || 0;
                    if (cant > 0 && costo > 0) {
                        detalles.push({
                            producto_id: prod.id,
                            producto_nombre: prod.nombre,
                            cantidad: cant,
                            costo_unitario: costo
                        });
                    }
                } catch (e) {}
            });

            if (detalles.length === 0) { alert('Completa al menos un producto correctamente'); return; }

            const body = {
                proveedor_id: provId,
                detalles: detalles,
                fecha_estimada: document.getElementById('ordenFechaEstimada').value || null
            };

            try {
                const btn = event?.submitter || document.querySelector('#formularioOrden button[type="submit"]');
                if (btn) { btn.disabled = true; btn.textContent = 'Creando...'; }

                const res = await fetch('/api/ordenes-compra', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    let msg = 'Error creando orden';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }

                await cargarOrdenesCompra();
                limpiarFormularioOrden();
                cambiarSubTab('prov-ordenes');
                alert('Orden de compra creada correctamente');
                if (btn) { btn.disabled = false; btn.textContent = 'üì• Crear Orden'; }
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
                const btn = document.querySelector('#formularioOrden button[type="submit"]');
                if (btn) { btn.disabled = false; btn.textContent = 'üì• Crear Orden'; }
            }
        }

        async function cargarOrdenesCompra() {
            try {
                const resp = await fetch('/api/ordenes-compra', { credentials: 'same-origin' });
                if (!resp.ok) throw new Error('Error cargando √≥rdenes');
                ordenesCompraList = await resp.json();
                mostrarOrdenesCompra();
            } catch (e) {
                console.error('Error cargando √≥rdenes:', e);
                const tbody = document.getElementById('ordenesTabla');
                if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="sin-datos">Error cargando √≥rdenes</td></tr>`;
            }
        }

        function mostrarOrdenesCompra(filtro = '') {
            const tbody = document.getElementById('ordenesTabla');
            if (!tbody) return;

            const q = (filtro || document.getElementById('buscadorOrdenes')?.value || '').toLowerCase();
            const estadoFiltro = document.getElementById('filtroEstadoOrden')?.value || '';

            let lista = (ordenesCompraList || []).filter(o => {
                const matchBusqueda = o.id.toLowerCase().includes(q) || o.proveedor_nombre.toLowerCase().includes(q);
                const matchEstado = !estadoFiltro || o.estado === estadoFiltro;
                return matchBusqueda && matchEstado;
            });

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="sin-datos">No hay √≥rdenes</td></tr>';
                return;
            }

            tbody.innerHTML = lista.map(o => {
                const fecha = new Date(o.fecha_creacion).toLocaleDateString('es-CO');
                const entrega = o.fecha_estimada ? new Date(o.fecha_estimada).toLocaleDateString('es-CO') : 'N/A';
                const estadoBadge = `<span class="estado-badge estado-${o.estado}">${o.estado}</span>`;
                return `<tr>
                    <td><strong>${escapeHtml(o.id)}</strong></td>
                    <td>${escapeHtml(o.proveedor_nombre)}</td>
                    <td>${fecha}</td>
                    <td>${entrega}</td>
                    <td>$${(o.total || 0).toLocaleString('es-CO')}</td>
                    <td>${estadoBadge}</td>
                    <td class="acciones-celda">
                        <button class="btn btn-peque√±o btn-primario" onclick="verDetallesOrden('${o.id}')" title="Ver">üëÅÔ∏è</button>
                        ${o.estado === 'pendiente' ? `<button class="btn btn-peque√±o" style="background:#4CAF50;color:white;" onclick="cambiarEstadoOrden('${o.id}', 'en_proceso')" title="Procesar">‚öôÔ∏è</button>` : ''}
                        ${o.estado === 'en_proceso' ? `<button class="btn btn-peque√±o" style="background:#2196F3;color:white;" onclick="cambiarEstadoOrden('${o.id}', 'recibido')" title="Recibir">‚úì</button>` : ''}
                        ${['pendiente', 'en_proceso'].includes(o.estado) ? `<button class="btn btn-peque√±o btn-peligro" onclick="cancelarOrden('${o.id}')" title="Cancelar">‚úï</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        }

        function filtrarOrdenes() { mostrarOrdenesCompra(); }

        function verDetallesOrden(id) {
            const orden = (ordenesCompraList || []).find(o => o.id === id);
            if (!orden) { alert('Orden no encontrada'); return; }

            const detalles = orden.detalles || [];
            const html = `
                <div style="padding: 20px;">
                    <p><strong>ID Orden:</strong> ${escapeHtml(orden.id)}</p>
                    <p><strong>Proveedor:</strong> ${escapeHtml(orden.proveedor_nombre)}</p>
                    <p><strong>Estado:</strong> <span class="estado-badge estado-${orden.estado}">${orden.estado}</span></p>
                    <p><strong>Fecha:</strong> ${new Date(orden.fecha_creacion).toLocaleDateString('es-CO')}</p>
                    <p><strong>Entrega Estimada:</strong> ${orden.fecha_estimada ? new Date(orden.fecha_estimada).toLocaleDateString('es-CO') : 'N/A'}</p>
                    <h4 style="margin-top: 20px;">Productos:</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead><tr style="background: #f0f0f0;"><th>Producto</th><th>Cantidad</th><th>Costo Unit.</th><th>Subtotal</th></tr></thead>
                        <tbody>
                            ${detalles.map(d => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td>${escapeHtml(d.producto_nombre)}</td>
                                    <td style="text-align:center;">${d.cantidad}</td>
                                    <td style="text-align:right;">$${d.costo_unitario.toLocaleString('es-CO')}</td>
                                    <td style="text-align:right;"><strong>$${d.subtotal.toLocaleString('es-CO')}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p style="margin-top: 15px; font-size: 16px;"><strong>Total: $${(orden.total || 0).toLocaleString('es-CO')}</strong></p>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-contenido modal-max-600">
                    <button class="btn-cerrar-modal" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                    <h2 class="modal-titulo">Detalles Orden</h2>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => modal.style.display = 'flex', 10);
        }

        async function cambiarEstadoOrden(id, nuevoEstado) {
            try {
                const res = await fetch(`/api/ordenes-compra/${id}/estado`, {
                    method: 'PUT',
                    credentials: 'same-origin',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({estado: nuevoEstado})
                });

                if (!res.ok) {
                    let msg = 'Error actualizando estado';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }

                await cargarOrdenesCompra();
                const estadoTexto = nuevoEstado === 'recibido' ? 'recibida' : nuevoEstado;
                alert(`Orden ${estadoTexto} correctamente`);
                if (nuevoEstado === 'recibido') {
                    alert('‚úì Stock actualizado autom√°ticamente');
                }
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }

        async function cancelarOrden(id) {
            if (!confirm('¬øCancelar orden? Esta acci√≥n es irreversible.')) return;
            try {
                const res = await fetch(`/api/ordenes-compra/${id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (!res.ok) {
                    let msg = 'Error cancelando orden';
                    try { const j = await res.json(); msg = j.error || j.message || msg; } catch(e) { try { msg = await res.text(); } catch(e) {} }
                    throw new Error(msg);
                }

                await cargarOrdenesCompra();
                alert('Orden cancelada');
            } catch (e) {
                console.error(e);
                alert('Error: ' + e.message);
            }
        }

        /**
         * Cargar y mostrar an√°lisis de proveedores
         */
        async function cargarAnalisisProveedores() {
            const container = document.querySelector('#subtab-prov-analisis .analisis-grid');
            if (!container) return;

            const provs = proveedoresList || [];
            const ordenes = ordenesCompraList || [];

            // Calcular m√©tricas
            const totalOrdenes = ordenes.length;
            const montoTotal = ordenes.reduce((sum, o) => sum + (o.total || 0), 0);
            const pendientes = ordenes.filter(o => o.estado === 'pendiente').length;
            const enProceso = ordenes.filter(o => o.estado === 'en_proceso').length;

            // Top proveedores por √≥rdenes
            const topProv = {};
            ordenes.forEach(o => {
                topProv[o.proveedor_id] = { nombre: o.proveedor_nombre, count: (topProv[o.proveedor_id]?.count || 0) + 1 };
            });

            const topLista = Object.entries(topProv)
                .map(([id, data]) => ({id, ...data}))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            // Actualizar cards
            document.getElementById('anaOrdenes').textContent = provs.length;
            document.getElementById('anaTotalOrdenes').textContent = totalOrdenes;
            document.getElementById('anaMonto').textContent = '$' + montoTotal.toLocaleString('es-CO');
            document.getElementById('anaPendientes').textContent = pendientes + enProceso;

            // Actualizar top proveedores
            const topHTML = topLista.length > 0 ? topLista.map(p => `
                <div class="top-item">
                    <span class="top-nombre">${escapeHtml(p.nombre)}</span>
                    <span class="top-cantidad">${p.count} √≥rden${p.count > 1 ? 'es' : ''}</span>
                </div>
            `).join('') : '<p class="sin-datos">Sin datos</p>';

            document.getElementById('topProveedores').innerHTML = topHTML;
        }

        /**
         * Muestra los productos en la tabla
         */
        function mostrarProductosTabla() {
            const tbody = document.getElementById('productosTabla');

            if (productosTab.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="sin-datos">No hay productos</td></tr>';
                return;
            }

            tbody.innerHTML = productosTab.map(producto => {
                let estadoStock;
                let claseStock;

                if (producto.stock === 0) {
                    estadoStock = '‚ùå Agotado';
                    claseStock = 'stock-agotado';
                } else if (producto.stock < 5) {
                    estadoStock = `‚ö†Ô∏è  ${producto.stock} unidades`;
                    claseStock = 'stock-bajo';
                } else {
                    estadoStock = `‚úì ${producto.stock}`;
                    claseStock = 'stock-disponible';
                }

                return `
                    <tr>
                        <td><strong>${producto.nombre}</strong></td>
                        <td><span class="badge-categoria">${producto.categoria}</span></td>
                        <td>${producto.descripcion || '-'}</td>
                        <td><span class="estado-stock ${claseStock}">${estadoStock}</span></td>
                        <td class="precio-celda">$${producto.precio.toFixed(2)}</td>
                        <td class="acciones-celda">
                            <button class="btn btn-peque√±o btn-primario" onclick="abrirEditar('${producto.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-peque√±o btn-peligro" onclick="eliminarProducto('${producto.id}')" title="Eliminar">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // =====================
        // MODAL: PEDIDO DE COMPRA
        // =====================
        function mostrarModalPedido(filas, csv) {
            // Crear contenido
            const container = document.getElementById('modalPedidoContent');
            if (!container) return;
            let html = '<div class="pedido-lista"><table class="tabla"><thead><tr><th>Producto</th><th>Categor√≠a</th><th>Stock</th><th>Sugerido</th></tr></thead><tbody>';
            filas.forEach(f => {
                html += `<tr><td>${escapeHtml(f.nombre)}</td><td>${escapeHtml(f.categoria)}</td><td>${f.stock}</td><td>${f.sugerido}</td></tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;

            // Guardar CSV en atributo para descarga
            container.dataset.csv = csv;

            // Mostrar modal
            document.getElementById('modalPedidoCompra')?.classList.add('activo');
        }

        function cerrarModalPedido() {
            document.getElementById('modalPedidoCompra')?.classList.remove('activo');
        }

        function descargarPedido() {
            const container = document.getElementById('modalPedidoContent');
            const csv = container?.dataset?.csv || '';
            if (!csv) { alert('CSV vac√≠o'); return; }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pedido_stock_bajo_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            return String(text)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
        }

        /**
         * Filtra la tabla de productos
         */
        function filtrarTablaProductos() {
            const busqueda = document.getElementById('buscadorProductos').value.toLowerCase();
            const filtroCategoria = document.getElementById('filtroCategoria').value;

            productosTab = productosCompletos.filter(p =>
                (p.nombre.toLowerCase().includes(busqueda) ||
                 p.descripcion.toLowerCase().includes(busqueda) ||
                 p.categoria.toLowerCase().includes(busqueda)) &&
                (filtroCategoria === '' || p.categoria === filtroCategoria)
            );
            mostrarProductosTabla();
        }

        /**
         * Guarda o actualiza un producto
         */
        async function guardarProducto(event, esEdicion = false) {
            event.preventDefault();

            const formulario = esEdicion ? 'formularioEditar' : 'formularioProducto';

            // Helper para obtener el id correcto del campo (los campos de edici√≥n usan CamelCase: editNombre)
            function fieldId(name) {
                if (!esEdicion) return name;
                // Capitalizar la primera letra del campo
                return 'edit' + name.charAt(0).toUpperCase() + name.slice(1);
            }

            const datos = {
                nombre: document.getElementById(fieldId('nombre')).value,
                descripcion: document.getElementById(fieldId('descripcion')).value,
                categoria: document.getElementById(fieldId('categoria')).value,
                stock: document.getElementById(fieldId('stock')).value,
                precio: document.getElementById(fieldId('precio')).value,
                imagen: document.getElementById(fieldId('imagen')).value
            };

            try {
                let url = '/api/productos';
                let metodo = 'POST';

                if (esEdicion) {
                    url += `/${productoActualEdicion}`;
                    metodo = 'PUT';
                }

                const respuesta = await fetch(url, {
                    method: metodo,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje(
                    esEdicion ? 'Producto actualizado exitosamente' : 'Producto creado exitosamente',
                    'exito'
                );

                if (esEdicion) {
                    cerrarModalEditar();
                } else {
                    limpiarFormulario();
                }

                cargarProductos();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        /**
         * Limpia el formulario de agregar
         */
        function limpiarFormulario() {
            document.getElementById('formularioProducto').reset();
            document.getElementById('tituloFormulario').textContent = '‚úèÔ∏è Agregar Nuevo Producto';
        }

        // ====================================================================
        // GESTI√ìN DE TABS Y SUB-TABS
        // ====================================================================

        /**
         * Cambia entre sub-tabs de productos
         */
        function cambiarSubTab(nombreSubTab) {
            // Ocultar todos los sub-tabs
            document.querySelectorAll('.sub-tab-contenido').forEach(tab => {
                tab.classList.remove('activo');
            });
            document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                btn.classList.remove('activo');
            });

            // Mostrar sub-tab seleccionado (si existe)
            const subTab = document.getElementById(`subtab-${nombreSubTab}`);
            if (subTab) subTab.classList.add('activo');

            // Intentar activar el bot√≥n correspondiente (fallback por si event no existe)
            let activated = false;
            try {
                if (event && event.target) {
                    event.target.classList.add('activo');
                    activated = true;
                }
            } catch (e) { /* ignore */ }

            if (!activated) {
                const btn = document.querySelector(`.sub-tab-btn[onclick*="cambiarSubTab('${nombreSubTab}')"]`);
                if (btn) btn.classList.add('activo');
            }

            // Cargar datos si es necesario
            if (nombreSubTab === 'lista-productos') {
                cargarProductos();
            } else if (nombreSubTab === 'gestionar-categorias') {
                cargarCategorias();
            } else if (nombreSubTab === 'stock-bajo') {
                cargarStockBajo();
                try { cargarProveedores(); } catch(e) {}
            } else if (nombreSubTab === 'prov-lista') {
                try { mostrarProveedores(''); } catch(e) {}
            } else if (nombreSubTab === 'prov-ordenes') {
                try { cargarSelectoOrdenes(); cargarOrdenesCompra(); } catch(e) {}
            } else if (nombreSubTab === 'prov-analisis') {
                try { cargarAnalisisProveedores(); } catch(e) {}
            }
        }

        /**
         * Carga y muestra las categor√≠as desde la API
         */
        async function cargarCategorias() {
            try {
                // Preferir la lista persistente de categor√≠as
                const respCat = await fetch('/api/categorias');
                if (!respCat.ok) throw new Error('No se pudieron cargar las categor√≠as');
                const categorias = await respCat.json();
                categoriasDisponibles = categorias || [];

                // Obtener productos para contar cantidades por categor√≠a
                const respuesta = await fetch('/api/productos');
                const productos = await respuesta.json();

                const contenedor = document.getElementById('listaCategorias');
                if (!categoriasDisponibles || categoriasDisponibles.length === 0) {
                    contenedor.innerHTML = '<p class="sin-datos">No hay categor√≠as</p>';
                } else {
                    contenedor.innerHTML = categoriasDisponibles.map(cat => `
                        <div class="categoria-item" data-cat="${cat}">
                            <div class="categoria-texto">
                                <span class="categoria-nombre">${cat}</span>
                                <span class="categoria-cantidad">${productos.filter(p => p.categoria === cat).length} productos</span>
                            </div>
                            <div class="categoria-acciones">
                                <button class="btn btn-peque√±o btn-primario btn-editar-cat" type="button">‚úèÔ∏è</button>
                                <button class="btn btn-peque√±o btn-peligro btn-eliminar-cat" type="button">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');

                    renderCategorias(categoriasDisponibles);
                    actualizarSelectCategorias(categoriasDisponibles);
                    actualizarFiltroCategorias(categoriasDisponibles);
                }
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                const contenedor = document.getElementById('listaCategorias');
                contenedor.innerHTML = '<p class="sin-datos">No fue posible cargar categor√≠as</p>';
            }
        }

            /**
             * Renderiza la lista de categor√≠as en el contenedor `listaCategorias`.
             * Usa `productosCompletos` para calcular la cantidad de productos por categor√≠a.
             */
            function renderCategorias(categorias) {
                const contenedor = document.getElementById('listaCategorias');
                if (!contenedor) return;

                if (!categorias || categorias.length === 0) {
                    contenedor.innerHTML = '<p class="sin-datos">No hay categor√≠as</p>';
                    return;
                }

                const productos = productosCompletos || [];

                contenedor.innerHTML = categorias.map(cat => {
                    const count = productos.filter(p => p.categoria === cat).length;
                    return `
                        <div class="categoria-item" data-cat="${cat}">
                            <div class="categoria-texto">
                                <span class="categoria-nombre">${cat}</span>
                                <span class="categoria-cantidad">${count} productos</span>
                            </div>
                            <div class="categoria-acciones">
                                <button class="btn btn-peque√±o btn-primario btn-editar-cat" type="button">‚úèÔ∏è</button>
                                <button class="btn btn-peque√±o btn-peligro btn-eliminar-cat" type="button">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Delegaci√≥n de eventos para botones de editar/eliminar categor√≠a
            document.getElementById('listaCategorias').addEventListener('click', (e) => {
                const editar = e.target.closest('.btn-editar-cat');
                if (editar) {
                    const item = editar.closest('.categoria-item');
                    const cat = item && item.dataset && item.dataset.cat;
                    if (cat) editarCategoria(cat);
                    return;
                }

                const eliminar = e.target.closest('.btn-eliminar-cat');
                if (eliminar) {
                    const item = eliminar.closest('.categoria-item');
                    const cat = item && item.dataset && item.dataset.cat;
                    if (cat) eliminarCategoria(cat);
                    return;
                }
            });

        /**
         * Actualiza el select de categor√≠as en el formulario
         */
        function actualizarSelectCategorias(categorias) {
            const select = document.getElementById('categoria');
            const opcionActual = select.value;
            
            select.innerHTML = '<option value="">-- Selecciona categor√≠a --</option>';
            
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                select.appendChild(option);
            });

            select.value = opcionActual;
            // Tambi√©n actualizar el select del modal de edici√≥n si existe
            const editSelect = document.getElementById('editCategoria');
            if (editSelect) {
                const opcionEditActual = editSelect.value;
                editSelect.innerHTML = '<option value="">-- Selecciona categor√≠a --</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    editSelect.appendChild(option);
                });
                // Si la opci√≥n actual ya no existe, lo dejamos en vac√≠o; sino, restauramos
                editSelect.value = opcionEditActual && categorias.includes(opcionEditActual) ? opcionEditActual : '';
            }
        }

        /**
         * Actualiza el select filtro de categor√≠as (sin volver a pedir productos)
         */
        function actualizarFiltroCategorias(categorias) {
            const filtroCategoria = document.getElementById('filtroCategoria');
            if (!filtroCategoria) return;
            const opcionActual = filtroCategoria.value;
            filtroCategoria.innerHTML = '<option value="">üìÅ Todas las categor√≠as</option>';
            categorias.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filtroCategoria.appendChild(option);
            });
            filtroCategoria.value = opcionActual;
        }

        /**
         * Actualiza las categor√≠as en ambos selects
         */
        async function actualizarCategoriasProducto() {
            try {
                const respuesta = await fetch('/api/productos');
                const productos = await respuesta.json();
                const categorias = [...new Set(productos.map(p => p.categoria))];
                
                // Actualizar filtro de categor√≠as en la lista
                const filtroCategoria = document.getElementById('filtroCategoria');
                const opcionActual = filtroCategoria.value;
                filtroCategoria.innerHTML = '<option value="">üìÅ Todas las categor√≠as</option>';
                categorias.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    filtroCategoria.appendChild(option);
                });
                filtroCategoria.value = opcionActual;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        /**
         * Agrega una nueva categor√≠a usando la API
         */
        async function agregarCategoria() {
            const nombreCategoria = document.getElementById('nombreCategoria').value.trim();
            if (!nombreCategoria) {
                mostrarMensaje('Ingresa un nombre para la categor√≠a', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/categorias', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombre: nombreCategoria })
                });

                const resultado = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error: ' + (resultado.error || 'no se pudo crear la categor√≠a'), 'error');
                    return;
                }

                document.getElementById('nombreCategoria').value = '';
                await cargarCategorias();
                mostrarMensaje('‚úì Categor√≠a registrada: ' + nombreCategoria, 'exito');
            } catch (error) {
                console.error('Error creando categor√≠a:', error);
                mostrarMensaje('Error al crear categor√≠a', 'error');
            }
        }

        /**
         * Edita el nombre de una categor√≠a v√≠a API
         */
        async function editarCategoria(oldName) {
            const nuevo = prompt('Nuevo nombre para la categor√≠a', oldName);
            if (!nuevo) return;
            const nuevoTrim = nuevo.trim();
            if (!nuevoTrim) {
                mostrarMensaje('Nombre inv√°lido', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/categorias/' + encodeURIComponent(oldName), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nuevo: nuevoTrim })
                });

                const resultado = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error: ' + (resultado.error || 'no se pudo actualizar'), 'error');
                    return;
                }

                await cargarCategorias();
                cargarProductos();
                mostrarMensaje('Categor√≠a actualizada', 'exito');
            } catch (error) {
                console.error('Error actualizando categor√≠a:', error);
                mostrarMensaje('Error al actualizar categor√≠a', 'error');
            }
        }

        /**
         * Elimina una categor√≠a v√≠a API y actualiza la UI
         */
        async function eliminarCategoria(name) {
            if (!confirm(`¬øEliminar la categor√≠a "${name}"? Esto no eliminar√° productos, pero se limpiar√° la categor√≠a en los productos que la usan.`)) return;

            try {
                const resp = await fetch('/api/categorias/' + encodeURIComponent(name), { method: 'DELETE' });
                const resultado = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error: ' + (resultado.error || 'no se pudo eliminar'), 'error');
                    return;
                }

                await cargarCategorias();
                cargarProductos();
                mostrarMensaje('Categor√≠a eliminada', 'exito');
            } catch (error) {
                console.error('Error eliminando categor√≠a:', error);
                mostrarMensaje('Error al eliminar categor√≠a', 'error');
            }
        }

        /**
         * Abre el modal de edici√≥n
         */
        async function abrirEditar(idProducto) {
            const producto = productosCompletos.find(p => p.id === idProducto);

            if (!producto) {
                mostrarMensaje('Producto no encontrado', 'error');
                return;
            }

            productoActualEdicion = idProducto;
            // Asegurarnos de que los selects est√°n poblados desde la BD antes de asignar valores
            try {
                if (!categoriasDisponibles || categoriasDisponibles.length === 0) {
                    await cargarCategorias();
                } else {
                    actualizarSelectCategorias(categoriasDisponibles);
                }
            } catch (e) {
                console.warn('No se pudieron cargar categor√≠as antes de editar:', e);
            }

            document.getElementById('editNombre').value = producto.nombre;
            document.getElementById('editDescripcion').value = producto.descripcion;
            // Si la categor√≠a del producto no est√° en la lista, a√±adimos temporalmente la opci√≥n
            const editSelect = document.getElementById('editCategoria');
            if (editSelect) {
                if (producto.categoria && ![...editSelect.options].some(o => o.value === producto.categoria)) {
                    const opt = document.createElement('option');
                    opt.value = producto.categoria;
                    opt.textContent = producto.categoria;
                    editSelect.appendChild(opt);
                }
                editSelect.value = producto.categoria || '';
            }

            document.getElementById('editStock').value = producto.stock;
            document.getElementById('editPrecio').value = producto.precio;
            document.getElementById('editImagen').value = producto.imagen;

            document.getElementById('modalEditarProducto').classList.add('activo');
        }

        /**
         * Cierra el modal de edici√≥n
         */
        function cerrarModalEditar() {
            document.getElementById('modalEditarProducto').classList.remove('activo');
            productoActualEdicion = null;
        }

        /**
         * Elimina un producto
         */
        async function eliminarProducto(idProducto) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) {
                return;
            }

            try {
                const respuesta = await fetch(`/api/productos/${idProducto}`, {
                    method: 'DELETE'
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('Producto eliminado exitosamente', 'exito');
                cargarProductos();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        // ====================================================================
        // GESTI√ìN DE VENTAS
        // ====================================================================

        /**
         * Muestra estad√≠sticas de ventas
         */
        function mostrarEstadisticasVentas() {
            const contenedor = document.getElementById('estadisticasVentas');

            const totalVentas = ventasCompletas.length;
            const montoTotal = ventasCompletas.reduce((sum, v) => sum + (parseFloat(v.total) || 0), 0);
            const ventaPromedioRaw = totalVentas > 0 ? montoTotal / totalVentas : 0;

            const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 });
            // Si prefieres mostrar USD o sin signo local, reemplazar currency

            contenedor.innerHTML = `
                <div class="tarjeta-estadistica">
                    <h3>Total de Ventas</h3>
                    <div class="valor">${totalVentas}</div>
                </div>
                <div class="tarjeta-estadistica">
                    <h3>Monto Total</h3>
                    <div class="valor">${fmt.format(montoTotal)}</div>
                </div>
                <div class="tarjeta-estadistica">
                    <h3>Venta Promedio</h3>
                    <div class="valor">${fmt.format(ventaPromedioRaw)}</div>
                </div>
            `;
        }

        /**
         * Muestra las ventas agrupadas por d√≠a
         */
        function mostrarVentasTabla() {
            const tabla = document.getElementById('ventasTabla');
            if (!ventasTab || ventasTab.length === 0) {
                tabla.innerHTML = '<tr><td colspan="6" class="sin-datos">No hay ventas que coincidan con la b√∫squeda</td></tr>';
                return;
            }
            const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 });
            // Ordenar ventas por fecha y hora descendente (m√°s reciente primero)
            const ventasOrdenadas = [...ventasTab].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            tabla.innerHTML = ventasOrdenadas.map(venta => {
                const fecha = new Date(venta.fecha);
                const fechaHora = fecha.toLocaleDateString('es-CO') + ' ' + fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
                const productos = Array.isArray(venta.items) ? venta.items.map(i => i.nombre).join(', ') : '';
                const totalVenta = fmt.format(parseFloat(venta.total) || 0);
                return `
                    <tr>
                        <td><code>${(venta.id || '').toString().substring(0, 12)}</code></td>
                        <td>${venta.cliente?.nombre || 'Cliente Gen√©rico'}</td>
                        <td>${fechaHora}</td>
                        <td>${productos}</td>
                        <td>${totalVenta}</td>
                        <td>
                            <button class="btn-venta-detalles" onclick="verDetallesVenta('${venta.id}')">üìÑ Ver Factura</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Filtra la tabla de ventas
         */
        function filtrarTablaVentas() {
            const busqueda = document.getElementById('buscadorVentas').value.trim().toLowerCase().replace(/\s+/g, '');
            // Aseguramos que ventasCompletas est√© inicializado
            if (!Array.isArray(ventasCompletas)) ventasCompletas = [];
            ventasTab = ventasCompletas.filter(v => {
                const idVenta = ((v.idVenta || v.id || '').toString().toLowerCase().replace(/\s+/g, ''));
                const nombreCliente = (v.cliente && v.cliente.nombre) ? v.cliente.nombre.toLowerCase().replace(/\s+/g, '') : '';
                if (!busqueda) return true;
                // Coincidencia estricta en ID o nombre de cliente
                return idVenta.includes(busqueda) || nombreCliente.includes(busqueda);
            });
            ventasTab = ventasTab.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            mostrarVentasTabla();
        }

        /**
         * Ver detalles de una venta (Factura)
         */
        function verDetallesVenta(idVenta) {
            const venta = ventasCompletas.find(v => v.id === idVenta);

            if (!venta) {
                mostrarMensaje('Venta no encontrada', 'error');
                return;
            }

            const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 });
            const fecha = new Date(venta.fecha);
            const fechaFormato = fecha.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const horaFormato = fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });

            const itemsHTML = venta.items.map(item => `
                <tr>
                    <td class="item-nombre">${item.nombre}</td>
                    <td class="item-centro">${item.cantidad}</td>
                    <td class="item-derecha">${fmt.format(parseFloat(item.precio) || 0)}</td>
                    <td class="item-derecha"><strong>${fmt.format(parseFloat(item.subtotal) || 0)}</strong></td>
                </tr>
            `).join('');

            const totalVenta = fmt.format(parseFloat(venta.total) || 0);

            const contenido = document.getElementById('detallesVentaContenido');
            contenido.innerHTML = `
                <div class="factura-modal">
                    <div class="factura-encabezado-modal">
                        <h2>üìÑ FACTURA DE VENTA</h2>
                        <p class="factura-id">ID: ${venta.id}</p>
                    </div>

                    <div class="factura-info-grid">
                        <div class="factura-info-col">
                            <p><strong>Empresa:</strong> Ferreter√≠a BriaNova</p>
                            <p><strong>Direcci√≥n:</strong> Sede principal</p>
                            <p><strong>Tel√©fono:</strong> ${venta.cliente.telefono || 'P√∫blico General'}</p>
                        </div>
                        <div class="factura-info-col">
                            <p><strong>Fecha:</strong> ${fechaFormato}</p>
                            <p><strong>Hora:</strong> ${horaFormato}</p>
                            <p><strong>Cliente:</strong> ${venta.cliente.nombre || 'P√∫blico General'}</p>
                        </div>
                    </div>

                    <div class="factura-tabla-contenedor">
                        <table class="factura-tabla">
                            <thead>
                                <tr>
                                    <th class="th-item">PRODUCTO</th>
                                    <th class="th-cantidad">CANTIDAD</th>
                                    <th class="th-precio">PRECIO UNIT.</th>
                                    <th class="th-subtotal">SUBTOTAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>

                    <div class="factura-totales-contenedor">
                        <div class="factura-total-row">
                            <span class="factura-total-label">TOTAL VENTA:</span>
                            <span class="factura-total-valor">${totalVenta}</span>
                        </div>
                    </div>

                    <div class="factura-pie">
                        <p>‚úì Transacci√≥n completada exitosamente</p>
                        <p class="factura-pie-peque√±o">Gracias por su compra - Vuelva pronto</p>
                    </div>
                </div>
            `;

            document.getElementById('modalDetallesVenta').classList.add('activo');
        }

        /**
         * Cierra el modal de detalles de venta
         */
        function cerrarModalVenta() {
            document.getElementById('modalDetallesVenta').classList.remove('activo');
        }

        // ====================================================================
        // FUNCIONES GENERALES
        // ====================================================================

        /**
         * Muestra un mensaje en la p√°gina
         */
        function mostrarMensaje(texto, tipo) {
            const contenedor = document.getElementById('mensajeContenedor');
            const mensaje = document.createElement('div');
            mensaje.className = `mensaje ${tipo}`;
            mensaje.textContent = texto;
            contenedor.innerHTML = '';
            contenedor.appendChild(mensaje);

            // Limpiar mensaje despu√©s de 3 segundos
            setTimeout(() => {
                contenedor.innerHTML = '';
            }, 3000);
        }

        /**
         * Cierra la sesi√≥n del usuario
         */
        async function cerrarSesion() {
            if (!confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                return;
            }

            try {
                await fetch('/api/logout');
                mostrarLogin();
                document.getElementById('formularioLogin').reset();
                document.getElementById('mensajeLoginError').style.display = 'none';
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                mostrarLogin();
            }
        }

        /**
         * Abre el punto de venta embebido en un iframe dentro de la pesta√±a
         */
        function abrirPuntoVenta() {
            const contenedor = document.querySelector('#tab-puntoventa .contenedor-punto-venta');
            if (!contenedor) return;

            // Si ya est√° abierto, no duplicar
            if (document.getElementById('iframePV')) return;

            // Limpiar contenido y crear contenedor compacto para el iframe (sin t√≠tulo grande)
            contenedor.innerHTML = `
                <div style="position:relative; width:100%; height: calc(100vh - 200px); margin-top:8px;">
                    <div style="position:absolute; top:12px; right:12px; z-index:50;">
                        <button class="btn btn-secundario" onclick="cerrarIframePV()" style="padding:0.5rem 0.9rem;">Cerrar</button>
                    </div>
                    <div style="position:absolute; inset:0; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 10px 30px rgba(11,22,38,0.06);">
                        <iframe id="iframePV" src="/punto-venta.html" style="width:100%;height:100%;border:0;display:block;" allowfullscreen></iframe>
                    </div>
                </div>
            `;
        }

        function cerrarIframePV() {
            const contenedor = document.querySelector('#tab-puntoventa .contenedor-punto-venta');
            if (!contenedor) return;
            // Restaurar contenido original
            contenedor.innerHTML = `
                <h2 class="seccion-titulo">üõí Sistema de Punto de Venta</h2>
                <p class="texto-punto-venta">Accede al sistema de ventas optimizado</p>
                <button class="btn btn-primario btn-grande-pv" onclick="abrirPuntoVenta()">\n                    Abrir Punto de Venta\n                </button>
            `;
        }

        // Escuchar mensajes desde el iframe (ej. petici√≥n para cerrar el POS)
        window.addEventListener('message', (e) => {
            try {
                // Validar origen si se desea (usar e.origin)
                const data = e.data;
                if (!data) return;
                if (typeof data === 'string' && data === 'close-pv') {
                    cerrarIframePV();
                } else if (data && data.type === 'close-pv') {
                    cerrarIframePV();
                }
            } catch (err) {
                console.warn('Error manejando mensaje desde iframe:', err);
            }
        });

        // Cerrar modales al hacer clic fuera
        document.addEventListener('click', (e) => {
            const modalEditar = document.getElementById('modalEditarProducto');
            const modalVenta = document.getElementById('modalDetallesVenta');

            if (e.target === modalEditar) {
                cerrarModalEditar();
            }
            if (e.target === modalVenta) {
                cerrarModalVenta();
            }
        });

        // ====================================================================
        // CONFIGURACI√ìN DE HORARIOS POS
        // ====================================================================

        async function cargarConfiguracionHorarios() {
            try {
                const resp = await fetch('/api/configuracion/horarios');
                if (!resp.ok) throw new Error('Error cargando horarios');
                const cfg = await resp.json();

                document.getElementById('cfgControlHorarios').checked = cfg.controlHorarios || false;
                document.getElementById('cfgHoraMinInicio').value = cfg.horaMinInicio || '08:00';
                document.getElementById('cfgHoraMaxInicio').value = cfg.horaMaxInicio || '08:30';
                document.getElementById('cfgHoraMinCierre').value = cfg.horaMinCierre || '17:00';

                console.log('Horarios cargados:', cfg);
            } catch (error) {
                console.error('Error cargando horarios:', error);
                alert('No se pudo cargar la configuraci√≥n de horarios');
            }
        }

        async function guardarConfiguracionHorarios() {
            try {
                const config = {
                    controlHorarios: document.getElementById('cfgControlHorarios').checked,
                    horaMinInicio: document.getElementById('cfgHoraMinInicio').value,
                    horaMaxInicio: document.getElementById('cfgHoraMaxInicio').value,
                    horaMinCierre: document.getElementById('cfgHoraMinCierre').value
                };

                const resp = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!resp.ok) throw new Error('Error guardando horarios');
                
                alert('‚úì Configuraci√≥n de horarios guardada correctamente');
                console.log('Horarios guardados:', config);
            } catch (error) {
                console.error('Error guardando horarios:', error);
                alert('Error al guardar la configuraci√≥n: ' + error.message);
            }
        }

        // ====================================================================
        // CONFIGURACI√ìN - Funciones JS
        // ====================================================================

        async function cargarConfiguracion() {
            try {
                const resp = await fetch('/api/config');
                if (!resp.ok) throw new Error('No autorizado');
                const cfg = await resp.json();

                document.getElementById('cfgSiteName').value = cfg.siteName || '';
                document.getElementById('cfgVersion').value = cfg.version || '';
                document.getElementById('cfgCurrency').value = cfg.currency || '';

                document.getElementById('infoUsuarioActual').textContent = document.getElementById('usuarioActual').textContent || '-';
                document.getElementById('infoVersion').textContent = cfg.version || '-';
            } catch (error) {
                console.warn('No se pudo cargar configuraci√≥n:', error);
            }
        }

        async function guardarConfiguracion() {
            const siteName = document.getElementById('cfgSiteName').value.trim();
            const version = document.getElementById('cfgVersion').value.trim();
            const currency = document.getElementById('cfgCurrency').value.trim();

            try {
                const resp = await fetch('/api/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ siteName, version, currency })
                });

                const result = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error guardando configuraci√≥n: ' + (result.error || ''), 'error');
                    return;
                }

                mostrarMensaje('Configuraci√≥n guardada', 'exito');
                cargarConfiguracion();
            } catch (error) {
                console.error('Error guardando configuraci√≥n:', error);
                mostrarMensaje('Error guardando configuraci√≥n', 'error');
            }
        }

        // Modal cambiar contrase√±a
        (function(){
            const modalHtml = `
            <div class="modal" id="modalCambiarPass">
                <div class="modal-contenido">
                    <h2 class="modal-titulo">Cambiar Contrase√±a Admin</h2>
                    <form id="formCambiarPass" onsubmit="return false;">
                        <div class="grupo-formulario">
                            <label>Contrase√±a Actual</label>
                            <input type="password" id="currentPass" required>
                        </div>
                        <div class="grupo-formulario">
                            <label>Contrase√±a Nueva</label>
                            <input type="password" id="newPass" required>
                        </div>
                        <div class="modal-botones">
                            <button class="btn btn-secundario" type="button" onclick="document.getElementById('modalCambiarPass').classList.remove('activo')">Cancelar</button>
                            <button class="btn btn-primario" id="btnCambiarPass">Cambiar</button>
                        </div>
                    </form>
                </div>
            </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'btnCambiarPass') {
                    cambiarPasswordAdmin();
                }
            });
        })();

        async function cambiarPasswordAdmin() {
            const current = document.getElementById('currentPass').value;
            const nuevo = document.getElementById('newPass').value;
            if (!current || !nuevo) return mostrarMensaje('Ingresa las contrase√±as', 'error');

            try {
                const resp = await fetch('/api/admin/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current, nuevo })
                });
                const resultado = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error: ' + (resultado.error || 'no se pudo cambiar'), 'error');
                    return;
                }

                document.getElementById('modalCambiarPass').classList.remove('activo');
                document.getElementById('formCambiarPass').reset();
                mostrarMensaje('Contrase√±a cambiada', 'exito');
            } catch (error) {
                console.error('Error cambiando contrase√±a:', error);
                mostrarMensaje('Error cambiando contrase√±a', 'error');
            }
        }

        async function resetearBaseDatos() {
            if (!confirm('¬øDeseas reiniciar la base de datos a valores por defecto? Se perder√°n los datos actuales.')) return;
            try {
                const resp = await fetch('/api/db/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: true })
                });
                const resultado = await resp.json();
                if (!resp.ok) {
                    mostrarMensaje('Error: ' + (resultado.error || ''), 'error');
                    return;
                }

                mostrarMensaje('Base de datos reiniciada', 'exito');
                // Recargar vistas
                cargarProductos();
                cargarCategorias();
                cargarVentas();
                cargarConfiguracion();
            } catch (error) {
                console.error('Error reset DB:', error);
                mostrarMensaje('Error al resetear DB', 'error');
            }
        }

        // ====================================================================
        // ANALYTICS Y REPORTES
        // ====================================================================

        let chartVentasPorHora, chartTopProductos, chartTendencia;

        /**
         * Filtra ventas seg√∫n el per√≠odo seleccionado
         */
        function obtenerVentasPorPeriodo() {
            const periodo = document.getElementById('selectorFecha').value;
            const ahora = new Date();
            let inicio;

            if (periodo === 'hoy') {
                inicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            } else if (periodo === 'semana') {
                const dia = ahora.getDay();
                inicio = new Date(ahora);
                inicio.setDate(ahora.getDate() - dia);
            } else if (periodo === 'mes') {
                inicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            } else {
                return ventasCompletas;
            }

            return ventasCompletas.filter(v => new Date(v.fecha) >= inicio);
        }

        /**
         * Actualiza los gr√°ficos y estad√≠sticas
         */
        function actualizarAnalytics() {
            const ventas = obtenerVentasPorPeriodo();
            mostrarEstadisticasAnalytics(ventas);
            crearGraficoVentasPorHora(ventas);
            crearGraficoTopProductos(ventas);
            crearGraficoTendencia(ventas);
            mostrarResumenProductos(ventas);
        }

        /**
         * Muestra estad√≠sticas principales
         */
        function mostrarEstadisticasAnalytics(ventas) {
            const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 });
            const totalVentas = ventas.reduce((sum, v) => sum + parseFloat(v.total || 0), 0);
            const cantidadProductos = ventas.reduce((sum, v) => sum + (v.items?.length || 0), 0);
            const promedioPorVenta = ventas.length > 0 ? totalVentas / ventas.length : 0;

            document.getElementById('statsPrincipales').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <p class="stat-label">Total de Ventas</p>
                        <p class="stat-valor">${fmt.format(totalVentas)}</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üõçÔ∏è</div>
                    <div class="stat-content">
                        <p class="stat-label">Transacciones</p>
                        <p class="stat-valor">${ventas.length}</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-content">
                        <p class="stat-label">Productos Vendidos</p>
                        <p class="stat-valor">${cantidadProductos}</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <p class="stat-label">Promedio por Venta</p>
                        <p class="stat-valor">${fmt.format(promedioPorVenta)}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Crea gr√°fico de ventas por hora
         */
        function crearGraficoVentasPorHora(ventas) {
            const ventasPorHora = {};
            for (let i = 0; i < 24; i++) {
                ventasPorHora[i] = 0;
            }

            ventas.forEach(v => {
                const hora = new Date(v.fecha).getHours();
                ventasPorHora[hora] += parseFloat(v.total || 0);
            });

            const ctx = document.getElementById('chartVentasPorHora').getContext('2d');
            
            if (chartVentasPorHora) chartVentasPorHora.destroy();
            
            chartVentasPorHora = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Ventas ($)',
                        data: Object.values(ventasPorHora),
                        backgroundColor: 'rgba(230, 57, 70, 0.7)',
                        borderColor: '#e63946',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBackgroundColor: 'rgba(230, 57, 70, 0.9)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' }
                        }
                    }
                }
            });
        }

        /**
         * Crea gr√°fico de top 5 productos
         */
        function crearGraficoTopProductos(ventas) {
            const productosVendidos = {};
            
            ventas.forEach(v => {
                v.items?.forEach(item => {
                    if (!productosVendidos[item.nombre]) {
                        productosVendidos[item.nombre] = 0;
                    }
                    productosVendidos[item.nombre] += parseFloat(item.subtotal || 0);
                });
            });

            const top5 = Object.entries(productosVendidos)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const ctx = document.getElementById('chartTopProductos').getContext('2d');
            
            if (chartTopProductos) chartTopProductos.destroy();
            
            chartTopProductos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top5.map(([nombre]) => nombre),
                    datasets: [{
                        data: top5.map(([, total]) => total),
                        backgroundColor: [
                            'rgba(230, 57, 70, 0.8)',
                            'rgba(164, 22, 26, 0.8)',
                            'rgba(237, 108, 110, 0.8)',
                            'rgba(252, 165, 163, 0.8)',
                            'rgba(255, 205, 205, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        /**
         * Crea gr√°fico de tendencia de ventas
         */
        function crearGraficoTendencia(ventas) {
            const ventasPorDia = {};
            
            ventas.forEach(v => {
                const fecha = new Date(v.fecha).toLocaleDateString('es-CO');
                if (!ventasPorDia[fecha]) {
                    ventasPorDia[fecha] = 0;
                }
                ventasPorDia[fecha] += parseFloat(v.total || 0);
            });

            const labels = Object.keys(ventasPorDia).sort();
            const datos = labels.map(fecha => ventasPorDia[fecha]);

            const ctx = document.getElementById('chartTendencia').getContext('2d');
            
            if (chartTendencia) chartTendencia.destroy();
            
            chartTendencia = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Ventas Diarias ($)',
                        data: datos,
                        borderColor: '#e63946',
                        backgroundColor: 'rgba(230, 57, 70, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#e63946',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'k' }
                        }
                    }
                }
            });
        }

        /**
         * Muestra resumen de productos en tabla
         */
        function mostrarResumenProductos(ventas) {
            const fmt = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 2 });
            const productosVendidos = {};
            
            ventas.forEach(v => {
                v.items?.forEach(item => {
                    if (!productosVendidos[item.nombre]) {
                        productosVendidos[item.nombre] = { cantidad: 0, total: 0 };
                    }
                    productosVendidos[item.nombre].cantidad += item.cantidad || 0;
                    productosVendidos[item.nombre].total += parseFloat(item.subtotal || 0);
                });
            });

            const totalGeneral = Object.values(productosVendidos).reduce((sum, p) => sum + p.total, 0);

            const html = Object.entries(productosVendidos)
                .sort(([, a], [, b]) => b.total - a.total)
                .map(([nombre, datos]) => {
                    const porcentaje = ((datos.total / totalGeneral) * 100).toFixed(1);
                    return `
                        <tr>
                            <td class="tabla-producto">${nombre}</td>
                            <td class="tabla-cantidad">${datos.cantidad}</td>
                            <td class="tabla-ingresos">${fmt.format(datos.total)}</td>
                            <td class="tabla-porcentaje">
                                <div class="barra-porcentaje">
                                    <div class="barra-relleno" style="width: ${porcentaje}%"></div>
                                </div>
                                <span>${porcentaje}%</span>
                            </td>
                        </tr>
                    `;
                }).join('');

            document.getElementById('cuerpoTablaResumen').innerHTML = html || '<tr><td colspan="4" class="sin-datos">Sin datos disponibles</td></tr>';
        }

        /**
         * Descarga reporte como CSV
         */
        function descargarReporte() {
            const ventas = obtenerVentasPorPeriodo();
            const periodo = document.getElementById('selectorFecha').value;
            
            let csv = 'REPORTE DE VENTAS\n';
            csv += `Per√≠odo: ${periodo}\n`;
            csv += `Fecha de Generaci√≥n: ${new Date().toLocaleString('es-CO')}\n\n`;
            
            csv += 'ID VENTA,FECHA,HORA,CLIENTE,CANTIDAD PRODUCTOS,TOTAL\n';
            ventas.forEach(v => {
                const fecha = new Date(v.fecha);
                const fechaStr = fecha.toLocaleDateString('es-CO');
                const horaStr = fecha.toLocaleTimeString('es-CO');
                const cantProductos = v.items?.length || 0;
                csv += `"${v.id}","${fechaStr}","${horaStr}","${v.cliente || 'P√∫blico'}",${cantProductos},${v.total}\n`;
            });

            csv += '\n\nDETALLE DE PRODUCTOS\n';
            csv += 'PRODUCTO,CANTIDAD,PRECIO UNITARIO,SUBTOTAL,VENTA ID\n';
            ventas.forEach(v => {
                v.items?.forEach(item => {
                    csv += `"${item.nombre}",${item.cantidad},${item.precio},${item.subtotal},"${v.id}"\n`;
                });
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_ventas_${periodo}_${new Date().getTime()}.csv`);
            link.click();
            mostrarMensaje('Reporte descargado correctamente', 'exito');
        }

        /**
         * Imprime los gr√°ficos
         */
        function imprimirAnalytics() {
            window.print();
        }

        // ====================================================================
        // GESTI√ìN DE REPARACIONES
        // ====================================================================

        let reparacionesTab = [];
        let reparacionesCompletas = [];
        let tecnicosTab = [];

        /**
         * Carga las reparaciones desde el servidor
         */
        async function cargarReparaciones() {
            try {
                const respuesta = await fetch('/api/reparaciones');
                reparacionesCompletas = respuesta.ok ? await respuesta.json() : [];
                reparacionesTab = [...reparacionesCompletas];
                mostrarReparacionesTabla();
                cargarTecnicosSelect();
            } catch (error) {
                mostrarMensaje('Error al cargar reparaciones: ' + error.message, 'error');
            }
        }

        /**
         * Carga los t√©cnicos desde el servidor
         */
        async function cargarTecnicos() {
            try {
                const respuesta = await fetch('/api/tecnicos');
                tecnicosTab = respuesta.ok ? await respuesta.json() : [];
                mostrarTecnicosLista();
                cargarTecnicosSelect();
            } catch (error) {
                mostrarMensaje('Error al cargar t√©cnicos: ' + error.message, 'error');
            }
        }

        /**
         * Carga t√©cnicos en los selects
         */
        function cargarTecnicosSelect() {
            const selectRep = document.getElementById('repTecnico');
            const selectEdit = document.getElementById('editRepTecnico');
            
            const html = '<option value="">-- Sin asignar --</option>' + tecnicosTab.map(t => 
                `<option value="${t.id}">${t.nombre}</option>`
            ).join('');
            
            if (selectRep) selectRep.innerHTML = html;
            if (selectEdit) selectEdit.innerHTML = html;
        }

        /**
         * Muestra las reparaciones en la tabla
         */
        function mostrarReparacionesTabla() {
            const tbody = document.getElementById('reparacionesTabla');
            if (!tbody) return;

            if (reparacionesTab.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="sin-datos">No hay reparaciones</td></tr>';
                return;
            }

            tbody.innerHTML = reparacionesTab.map(rep => {
                const fechaIngreso = new Date(rep.fechaIngreso).toLocaleDateString('es-CO');
                const tecnico = tecnicosTab.find(t => t.id === rep.tecnicoAsignado);
                
                let estadoClase = 'recibido';
                if (rep.estado === 'Diagn√≥stico') estadoClase = 'diagnostico';
                else if (rep.estado === 'En Reparaci√≥n') estadoClase = 'reparacion';
                else if (rep.estado === 'Listo') estadoClase = 'listo';
                else if (rep.estado === 'Entregado') estadoClase = 'entregado';

                return `
                    <tr>
                        <td><strong>${rep.orden}</strong></td>
                        <td>${rep.cliente?.nombre || '-'}</td>
                        <td>${rep.equipo || '-'}</td>
                        <td><span class="estado-badge-pro ${estadoClase}">${rep.estado}</span></td>
                        <td>${fechaIngreso}</td>
                        <td>${tecnico?.nombre || '-'}</td>
                        <td class="acciones-celda">
                            <div class="acciones-reparacion">
                                <button class="btn-accion btn-ver" onclick="verReparacionDetalle('${rep.id}')" data-tooltip="Ver detalles">üëÅÔ∏è</button>
                                <button class="btn-accion btn-editar" onclick="editarReparacion('${rep.id}')" data-tooltip="Editar">‚úèÔ∏è</button>
                                <button class="btn-accion btn-eliminar" onclick="mostrarConfirmarEliminarReparacion('${rep.id}')" data-tooltip="Eliminar">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        /**
         * Muestra los t√©cnicos en la lista
         */
        function mostrarTecnicosLista() {
            const contenedor = document.getElementById('listaTecnicos');
            if (!contenedor) return;

            if (tecnicosTab.length === 0) {
                contenedor.innerHTML = '<p class="sin-datos">No hay t√©cnicos registrados</p>';
                return;
            }

            contenedor.innerHTML = tecnicosTab.map(t => `
                <div class="item-categoria" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 6px; margin-bottom: 10px;">
                    <div class="info-categoria">
                        <strong>${t.nombre}</strong>
                        <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                            üì± ${t.telefono || '-'} | üìß ${t.email || '-'}
                        </p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-accion btn-editar" onclick="editarTecnico('${t.id}')" data-tooltip="Editar">‚úèÔ∏è</button>
                        <button class="btn-accion btn-eliminar" onclick="eliminarTecnico('${t.id}')" data-tooltip="Eliminar">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        /**
         * Filtra la tabla de reparaciones
         */
        function filtrarTablaReparaciones() {
            const busqueda = document.getElementById('buscadorReparaciones')?.value.toLowerCase() || '';
            const estado = document.getElementById('filtroEstadoReparacion')?.value || '';

            reparacionesTab = reparacionesCompletas.filter(r => {
                const coincideBusqueda = !busqueda || 
                    r.cliente?.nombre?.toLowerCase().includes(busqueda) ||
                    r.orden?.toLowerCase().includes(busqueda) ||
                    r.equipo?.toLowerCase().includes(busqueda);
                
                const coincideEstado = !estado || r.estado === estado;
                
                return coincideBusqueda && coincideEstado;
            });

            mostrarReparacionesTabla();
        }

        /**
         * Guarda o actualiza una reparaci√≥n
         */
        async function guardarReparacion(event) {
            event.preventDefault();

            const datos = {
                cliente: {
                    nombre: document.getElementById('repClienteNombre').value,
                    telefono: document.getElementById('repClienteTelefono').value,
                    email: document.getElementById('repClienteEmail').value,
                    cedula: document.getElementById('repClienteCedula').value
                },
                tipo: document.getElementById('repTipo').value,
                equipo: document.getElementById('repEquipo').value,
                marca: document.getElementById('repMarca').value,
                modelo: document.getElementById('repModelo').value,
                serial: document.getElementById('repSerial').value,
                fallaReportada: document.getElementById('repFallaReportada').value,
                tecnicoAsignado: document.getElementById('repTecnico').value || null,
                fechaEntregaEstimada: document.getElementById('repFechaEntrega').value || null
            };

            try {
                const respuesta = await fetch('/api/reparaciones', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('Reparaci√≥n #' + resultado.reparacion.orden + ' creada exitosamente', 'exito');
                limpiarFormularioReparacion();
                cargarReparaciones();
                cambiarSubTab('lista-reparaciones');

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        /**
         * Limpia el formulario de reparaci√≥n
         */
        function limpiarFormularioReparacion() {
            const form = document.getElementById('formularioReparacion');
            if (form) form.reset();
            document.getElementById('tituloFormularioReparacion').textContent = 'üîß Agregar Nueva Reparaci√≥n';
        }

        /**
         * Ver detalles de una reparaci√≥n
         */
        // ====================================================================
        // FUNCIONES DE MODALES
        // ====================================================================

        let reparacionEnEdicion = null;
        let tecnicoEnEdicion = null;

        function abrirModal(idModal) {
            const modal = document.getElementById(idModal);
            if (modal) {
                modal.classList.add('activo');
            }
        }

        function cerrarModal(idModal) {
            const modal = document.getElementById(idModal);
            if (modal) {
                modal.classList.remove('activo');
            }
        }

        // ====================================================================
        // VER REPARACI√ìN - MODAL PROFESIONAL
        // ====================================================================

        function verReparacionDetalle(id) {
            const reparacion = reparacionesCompletas.find(r => r.id === id);
            if (!reparacion) {
                mostrarMensaje('Reparaci√≥n no encontrada', 'error');
                return;
            }

            const tecnico = tecnicosTab.find(t => t.id === reparacion.tecnicoAsignado);
            const fechaIngreso = new Date(reparacion.fechaIngreso).toLocaleDateString('es-CO');
            const fechaEntrega = reparacion.fechaEntregaEstimada 
                ? new Date(reparacion.fechaEntregaEstimada).toLocaleDateString('es-CO')
                : 'No definida';

            let estadoClase = 'recibido';
            if (reparacion.estado === 'Diagn√≥stico') estadoClase = 'diagnostico';
            else if (reparacion.estado === 'En Reparaci√≥n') estadoClase = 'reparacion';
            else if (reparacion.estado === 'Listo') estadoClase = 'listo';
            else if (reparacion.estado === 'Entregado') estadoClase = 'entregado';

            const html = `
                <div class="detalles-grid">
                    <div class="detalle-item">
                        <div class="detalle-label">üìã Orden</div>
                        <div class="detalle-valor">${reparacion.orden}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">‚è±Ô∏è Estado</div>
                        <div><span class="estado-badge-pro ${estadoClase}">${reparacion.estado}</span></div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üë§ Cliente</div>
                        <div class="detalle-valor">${reparacion.cliente?.nombre || '-'}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üì± Tel√©fono</div>
                        <div class="detalle-valor">${reparacion.cliente?.telefono || '-'}</div>
                    </div>
                </div>

                <hr style="margin: 16px 0; border: none; border-top: 1px solid #e0e0e0;">

                <div class="detalles-grid">
                    <div class="detalle-item">
                        <div class="detalle-label">üíª Equipo</div>
                        <div class="detalle-valor">${reparacion.equipo || '-'}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üè∑Ô∏è Marca/Modelo</div>
                        <div class="detalle-valor">${reparacion.marca || '-'} ${reparacion.modelo || ''}</div>
                    </div>
                </div>

                <div style="margin-top: 16px; padding: 12px; background: #fff3e0; border-radius: 6px;">
                    <div style="font-weight: 600; color: #e65100; margin-bottom: 8px;">üîß Falla Reportada</div>
                    <div style="color: #555;">${reparacion.fallaReportada || '-'}</div>
                </div>

                ${reparacion.diagnostico ? `
                <div style="margin-top: 12px; padding: 12px; background: #e3f2fd; border-radius: 6px;">
                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">üîç Diagn√≥stico</div>
                    <div style="color: #555;">${reparacion.diagnostico}</div>
                </div>
                ` : ''}

                <div class="detalles-grid" style="margin-top: 16px;">
                    <div class="detalle-item">
                        <div class="detalle-label">üë®‚Äçüîß T√©cnico Asignado</div>
                        <div class="detalle-valor">${tecnico?.nombre || 'Sin asignar'}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üí∞ Costo Estimado</div>
                        <div class="detalle-valor">$${reparacion.costoEstimado?.toLocaleString() || '0'}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üìÖ Ingreso</div>
                        <div class="detalle-valor">${fechaIngreso}</div>
                    </div>
                    <div class="detalle-item">
                        <div class="detalle-label">üìÖ Entrega Estimada</div>
                        <div class="detalle-valor">${fechaEntrega}</div>
                    </div>
                </div>
            `;

            document.getElementById('modalVerRepContent').innerHTML = html;
            abrirModal('modalVerReparacion');
        }

        // ====================================================================
        // EDITAR REPARACI√ìN - MODAL PROFESIONAL
        // ====================================================================

        function editarReparacion(id) {
            const reparacion = reparacionesCompletas.find(r => r.id === id);
            if (!reparacion) {
                mostrarMensaje('Reparaci√≥n no encontrada', 'error');
                return;
            }

            reparacionEnEdicion = reparacion.id;

            // Asegurar que los t√©cnicos est√°n cargados en el select
            cargarTecnicosSelect();

            // Llenar modal de edici√≥n
            document.getElementById('editRepClienteNombre').value = reparacion.cliente?.nombre || '';
            document.getElementById('editRepClienteTelefono').value = reparacion.cliente?.telefono || '';
            document.getElementById('editRepEquipo').value = reparacion.equipo || '';
            document.getElementById('editRepEstado').value = reparacion.estado || '';
            document.getElementById('editRepDiagnostico').value = reparacion.diagnostico || '';
            document.getElementById('editRepCosto').value = reparacion.costoEstimado || 0;
            document.getElementById('editRepTecnico').value = reparacion.tecnicoAsignado || '';

            abrirModal('modalEditarReparacion');
        }

        /**
         * Guarda reparaci√≥n editada
         */
        async function guardarReparacionEditada(event) {
            event.preventDefault();

            if (!reparacionEnEdicion) {
                mostrarMensaje('Error: No hay reparaci√≥n en edici√≥n', 'error');
                return;
            }

            const datos = {
                estado: document.getElementById('editRepEstado').value,
                diagnostico: document.getElementById('editRepDiagnostico').value,
                costoEstimado: parseFloat(document.getElementById('editRepCosto').value) || 0,
                tecnicoAsignado: document.getElementById('editRepTecnico').value || null
            };

            try {
                const respuesta = await fetch(`/api/reparaciones/${reparacionEnEdicion}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('‚úÖ Reparaci√≥n actualizada exitosamente', 'exito');
                cerrarModal('modalEditarReparacion');
                reparacionEnEdicion = null;
                cargarReparaciones();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        // ====================================================================
        // ELIMINAR REPARACI√ìN - MODAL CONFIRMACI√ìN
        // ====================================================================

        function mostrarConfirmarEliminarReparacion(id) {
            const reparacion = reparacionesCompletas.find(r => r.id === id);
            if (!reparacion) {
                mostrarMensaje('Reparaci√≥n no encontrada', 'error');
                return;
            }

            reparacionEnEdicion = id;
            document.getElementById('elimRepInfo').textContent = `Orden: ${reparacion.orden} - ${reparacion.cliente?.nombre}`;
            abrirModal('modalEliminarReparacion');
        }

        async function confirmarEliminarReparacion() {
            if (!reparacionEnEdicion) {
                mostrarMensaje('Error: No hay reparaci√≥n seleccionada', 'error');
                return;
            }

            try {
                const respuesta = await fetch(`/api/reparaciones/${reparacionEnEdicion}`, {
                    method: 'DELETE'
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('üóëÔ∏è Reparaci√≥n eliminada exitosamente', 'exito');
                cerrarModal('modalEliminarReparacion');
                reparacionEnEdicion = null;
                cargarReparaciones();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        // ====================================================================
        // EDITAR T√âCNICO - MODAL
        // ====================================================================

        function editarTecnico(id) {
            const tecnico = tecnicosTab.find(t => t.id === id);
            if (!tecnico) {
                mostrarMensaje('T√©cnico no encontrado', 'error');
                return;
            }

            tecnicoEnEdicion = id;
            document.getElementById('editTecNombre').value = tecnico.nombre || '';
            document.getElementById('editTecTelefono').value = tecnico.telefono || '';
            document.getElementById('editTecEmail').value = tecnico.email || '';

            abrirModal('modalEditarTecnico');
        }

        /**
         * Guarda t√©cnico editado
         */
        async function guardarTecnicoEditado(event) {
            event.preventDefault();

            if (!tecnicoEnEdicion) {
                mostrarMensaje('Error: No hay t√©cnico en edici√≥n', 'error');
                return;
            }

            const datos = {
                nombre: document.getElementById('editTecNombre').value,
                telefono: document.getElementById('editTecTelefono').value,
                email: document.getElementById('editTecEmail').value
            };

            try {
                const respuesta = await fetch(`/api/tecnicos/${tecnicoEnEdicion}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('‚úÖ T√©cnico actualizado exitosamente', 'exito');
                cerrarModal('modalEditarTecnico');
                tecnicoEnEdicion = null;
                cargarTecnicos();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        /**
         * Agrega un nuevo t√©cnico
         */
        async function agregarTecnico() {
            const nombre = document.getElementById('tecNombre').value;
            if (!nombre) {
                mostrarMensaje('Ingresa el nombre del t√©cnico', 'error');
                return;
            }

            const datos = {
                nombre: nombre,
                telefono: document.getElementById('tecTelefono').value,
                email: document.getElementById('tecEmail').value
            };

            try {
                const respuesta = await fetch('/api/tecnicos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('T√©cnico "' + resultado.nombre + '" agregado exitosamente', 'exito');
                document.getElementById('tecNombre').value = '';
                document.getElementById('tecTelefono').value = '';
                document.getElementById('tecEmail').value = '';
                cargarTecnicos();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }

        /**
         * Elimina un t√©cnico
         */
        async function eliminarTecnico(id) {
            if (!confirm('¬øEliminar este t√©cnico?')) {
                return;
            }

            try {
                const respuesta = await fetch(`/api/tecnicos/${id}`, {
                    method: 'DELETE'
                });

                const resultado = await respuesta.json();

                if (!respuesta.ok) {
                    mostrarMensaje('Error: ' + resultado.error, 'error');
                    return;
                }

                mostrarMensaje('T√©cnico eliminado exitosamente', 'exito');
                cargarTecnicos();

            } catch (error) {
                mostrarMensaje('Error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>